<!DOCTYPE html>
<html lang="es">
<head>
    <link rel="icon" type="image/png" href="fav.png">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reporte de Huecos en Góndola</title>
    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
    

    <script type="module">

        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs, query, where, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        

        const firebaseConfig = {
            apiKey: "AIzaSyBvL_rQFZf8427SuBG8Ua_7YNlNY9kclZ4",
            authDomain: "huecos-96c8c.firebaseapp.com",
            projectId: "huecos-96c8c",
            storageBucket: "huecos-96c8c.firebasestorage.app",
            messagingSenderId: "545038530680",
            appId: "1:545038530680:web:8a3bfdc4334a0ea0b4d58d",
            measurementId: "G-0YDTR33E5S"
        };


        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        

        window.firebase = { 
            db, 
            collection, 
            addDoc, 
            getDocs, 
            query, 
            where, 
            doc, 
            setDoc, 
            getDoc 
        };
        
        console.log('🔥 Firebase SDK cargado correctamente');
        

        window.firebaseLoaded = true;
    </script>

    <style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --accent-color: #e74c3c;
            --light-color: #ecf0f1;
            --dark-color: #34495e;
            --success-color: #2ecc71;
            --warning-color: #f39c12;
            --border-radius: 8px;
            --box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #f5f7fa;
            color: #333;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            background-color: var(--primary-color);
            color: white;
            padding: 20px;
            border-radius: var(--border-radius);
            margin-bottom: 30px;
            box-shadow: var(--box-shadow);
        }
        
        h1 {
            text-align: center;
            margin-bottom: 20px;
            font-size: 28px;
        }
        
        nav {
            display: flex;
            justify-content: center;
            gap: 15px;
            flex-wrap: wrap;
        }
        
        .nav-btn {
            background-color: var(--dark-color);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
        }
        
        .nav-btn:hover {
            background-color: var(--secondary-color);
            transform: translateY(-2px);
        }
        
        .nav-btn.active {
            background-color: var(--secondary-color);
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }
        
        main {
            background-color: white;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            padding: 30px;
            min-height: 500px;
        }
        
        section {
            display: none;
        }
        
        .seccion-activa {
            display: block;
            animation: fadeIn 0.5s ease;
        }
        
        .seccion-oculta {
            display: none;
        }
        
        h2 {
            color: var(--primary-color);
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--light-color);
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--dark-color);
        }
        
        input, select, textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: var(--border-radius);
            font-size: 16px;
            transition: border 0.3s;
        }
        
        input:focus, select:focus, textarea:focus {
            border-color: var(--secondary-color);
            outline: none;
            box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2);
        }
        
        textarea {
            min-height: 200px;
            font-family: monospace;
            font-size: 11px;
            resize: vertical;
        }
        
        button:not(.nav-btn) {
            background-color: var(--secondary-color);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        
        button:not(.nav-btn):hover {
            background-color: #2980b9;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        
        #status {
    position: fixed;
    top: 20px;
    right: 20px;
    z-index: 1000;
    padding: 15px 20px;
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    max-width: 400px;
    font-weight: 600;
    animation: slideIn 0.3s ease;
}

@keyframes slideIn {
    from {
        transform: translateX(100%);
        opacity: 0;
    }
    to {
        transform: translateX(0);
        opacity: 1;
    }
}
        
       .success {
    background-color: #d4edda;
    color: #155724;
    border: 1px solid #c3e6cb;
}

.error {
    background-color: #f8d7da;
    color: #721c24;
    border: 1px solid #f5c6cb;
}

.processing {
    background-color: #cce7ff;
    color: #004085;
    border: 1px solid #b3d7ff;
}
        
        .date-selector {
            display: flex;
            gap: 15px;
            align-items: center;
            margin-bottom: 25px;
            flex-wrap: wrap;
        }
        
        .date-selector input {
            width: auto;
        }
        
        .resumen-container {
            background-color: #f8f9fa;
            border-radius: var(--border-radius);
            padding: 20px;
            box-shadow: inset 0 0 5px rgba(0, 0, 0, 0.05);
        }
        
        .resumen-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .resumen-title {
            font-size: 24px;
            color: var(--primary-color);
            font-weight: bold;
        }
        
        .resumen-date {
            font-size: 16px;
            color: var(--dark-color);
        }
        
        .resumen-total {
            font-size: 18px;
            margin-bottom: 20px;
            color: var(--dark-color);
        }
        
        .resumen-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            background: white;
        }
        
        .resumen-table th, .resumen-table td {
            padding: 12px 15px;
            text-align: left;
            border: 1px solid #ddd;
        }
        
        .resumen-table th {
            background-color: #f2f2f2;
            font-weight: bold;
            color: var(--primary-color);
        }
        
        .resumen-table tr:nth-child(even) {
            background-color: #f8f9fa;
        }
        
        .resumen-table tr:hover {
            background-color: #e9ecef;
        }
        
        .contador-lineas {
            margin-top: 10px;
            font-size: 14px;
            color: var(--dark-color);
        }
        
        .auto-navigate {
    position: fixed;
    top: 80px; 
    right: 20px;
    z-index: 999;
    padding: 15px 20px;
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    max-width: 400px;
    background-color: #e8f4fd;
    color: #004085;
    border: 1px solid #b3d7ff;
    animation: slideIn 0.3s ease;
}
        


.notificacion-flotante {
    position: fixed;
    top: 20px;
    right: 20px;
    z-index: 10000; 
    padding: 15px 20px;
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    max-width: 400px;
    font-weight: 600;
    animation: slideIn 0.3s ease;
    display: flex;
    align-items: center;
    gap: 10px;
}

.notificacion-success {
    background-color: #d4edda;
    color: #155724;
    border: 1px solid #c3e6cb;
}

.notificacion-error {
    background-color: #f8d7da;
    color: #721c24;
    border: 1px solid #f5c6cb;
}

.notificacion-processing {
    background-color: #cce7ff;
    color: #004085;
    border: 1px solid #b3d7ff;
}

.notificacion-warning {
    background-color: #fff3cd;
    color: #856404;
    border: 1px solid #ffeaa7;
}

@keyframes slideIn {
    from {
        transform: translateX(100%);
        opacity: 0;
    }
    to {
        transform: translateX(0);
        opacity: 1;
    }
}

@keyframes slideOut {
    from {
        transform: translateX(0);
        opacity: 1;
    }
    to {
        transform: translateX(100%);
        opacity: 0;
    }
}
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .firebase-status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            font-size: 14px;
        }
        
        .firebase-connected {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .firebase-error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .firebase-config {
            background-color: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        
        @media (max-width: 768px) {
            nav {
                flex-direction: column;
            }
            
            .date-selector {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .date-selector input, .date-selector button {
                width: 100%;
            }
            
            .resumen-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
        }

        .contador-lineas {
    font-size: 14px;
    font-weight: bold;
    color: #2c3e50;
    margin-top: 5px;
    text-align: right;
    padding: 2px 8px;
    background-color: #f8f9fa;
    border-radius: 4px;
    display: inline-block;
}
    </style>
    

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
</head>

<body>
    <div class="container">
        <header>
            <h1>Reporte de Huecos en Góndola</h1>
            
             <div class="tienda-selector" style="margin: 15px 0; text-align: center;">
        <label for="select-tienda" style="color: white; margin-right: 10px; font-size: 16px;">🏪 Tienda:</label>
        <select id="select-tienda" style="padding: 10px 15px; border-radius: 8px; border: none; font-size: 16px; min-width: 300px;">
    <option value="1092" selected>1092 - San Juan Norte</option>
            <option value="1057">1057 - Comodoro Rivadavia</option>
            <option value="3604">3604 - Paraná</option>
            <option value="1010">1010 - Córdoba Sur</option>
            <option value="1099">1099 - Posadas II</option>
            <option value="1074">1074 - Goya (Ctes)</option>
            <option value="1018">1018 - Quilmes</option>
            <option value="1110">1110 - Claypole</option>
            <option value="1055">1055 - Villa Mercedes</option>
            <option value="1078">1078 - Salta Tartagal</option>
            <option value="1046">1046 - Pergamino</option>
            <option value="1077">1077 - Gral Pico (La Pampa)</option>
            <option value="1098">1098 - R.S. Peña, Chaco</option>
            <option value="1031">1031 - Jujuy</option>
            <option value="1043">1043 - Laferrere</option>
            <option value="1119">1119 - Moreno Derqui</option>
            <option value="1058">1058 - Resistencia</option>
            <option value="1061">1061 - Junín</option>
            <option value="1108">1108 - Puerto Madryn</option>
            <option value="1060">1060 - Fuerza Aérea (Cba)</option>
            <option value="1007">1007 - La Rioja</option>
            <option value="1030">1030 - José C Paz</option>
            <option value="1111">1111 - San Pedro de Jujuy</option>
            <option value="1056">1056 - Villa Nueva</option>
            <option value="1116">1116 - Moron</option>
            <option value="1039">1039 - Paraná 2</option>
            <option value="3601">3601 - La Plata</option>
            <option value="1026">1026 - Catamarca</option>
            <option value="1097">1097 - Donato Alvarez (Cba)</option>
            <option value="1014">1014 - Lujan</option>
            <option value="1011">1011 - Salta</option>
            <option value="1054">1054 - Olavarría</option>
            <option value="1100">1100 - Santa Rosa (La Pampa) II</option>
            <option value="1087">1087 - Pilar</option>
            <option value="1080">1080 - Santiago del Estero Sur</option>
            <option value="3606">3606 - Córdoba Este</option>
            <option value="1052">1052 - Oran</option>
            <option value="1024">1024 - Formosa</option>
            <option value="1028">1028 - Alte Brown</option>
            <option value="1114">1114 - Clorinda</option>
            <option value="1086">1086 - Formosa II</option>
            <option value="1059">1059 - Gonzalez Catán</option>
            <option value="1029">1029 - Moreno</option>
            <option value="1050">1050 - Lanús</option>
            <option value="2998">2998 - San Justo</option>
            <option value="2999">2999 - Avellaneda</option>
            <option value="1015">1015 - Maipú</option>
            <option value="3603">3603 - Santa Fe</option>
            <option value="1023">1023 - La Pampa</option>
            <option value="1045">1045 - Hurlingham (AV. Vergara)</option>
            <option value="3613">3613 - Mendoza</option>
            <option value="1004">1004 - San Fernando</option>
            <option value="1085">1085 - Corrientes (Av. Maipú)</option>
            <option value="1093">1093 - Comodoro Rivadavia Norte</option>
            <option value="1067">1067 - San Martín (Mza)</option>
            <option value="1042">1042 - Trelew</option>
            <option value="1008">1008 - Corrientes</option>
            <option value="1012">1012 - Santiago</option>
            <option value="1037">1037 - San Martin</option>
            <option value="1115">1115 - General Roca</option>
            <option value="1020">1020 - Tucumán</option>
            <option value="1051">1051 - Posadas</option>
            <option value="1044">1044 - Hurlingham (AV. Villegas)</option>
            <option value="1096">1096 - Caseros</option>
            <option value="1016">1016 - Avellaneda 2</option>
            <option value="1027">1027 - Mataderos</option>
            <option value="3602">3602 - Bahía Blanca</option>
            <option value="1002">1002 - Rio IV</option>
            <option value="1003">1003 - San Luis</option>
            <option value="1005">1005 - Las Heras</option>
            <option value="3605">3605 - Córduba Oeste</option>
            <option value="1036">1036 - Moreno Shopping</option>
            <option value="1084">1084 - San Vicente</option>
            <option value="1075">1075 - Salta Fuerza Aérea</option>
            <option value="1013">1013 - Tigre</option>
            <option value="1038">1038 - Cipolletti</option>
            <option value="1032">1032 - Malvinas Arg</option>
            <option value="1076">1076 - Lomas de Zamora</option>
            <option value="1068">1068 - Palmares (Mza)</option>
            <option value="1053">1053 - Viedma</option>
            <option value="1035">1035 - 3 de Febrero</option>
            <option value="1106">1106 - Tuc. Ejército Del Norte</option>
            <option value="1081">1081 - Rawson San Juan</option>
            <option value="3608">3608 - Neuquén</option>
            <option value="4001">4001 - Campana</option>
            <option value="1088">1088 - Tuc. Concepción</option>
            <option value="1006">1006 - San Juan</option>
            <option value="2997">2997 - Grafa</option>
            <option value="1021">1021 - Neuquén 2</option>
            <option value="1033">1033 - Rio Salí</option>
            <option value="1022">1022 - Bariloche</option>
            <option value="1082">1082 - Tucumán (Av. Jujuy)</option>
            <option value="1017">1017 - La Tablada</option>
        </select>
    </div>

    <nav>
        <button id="btn-cargar" class="nav-btn active">Cargar Datos</button>
        <button id="btn-resumen" class="nav-btn">Ver Resumen</button>
        <button id="btn-reporte" class="nav-btn">Generar Reporte</button>
        <button id="btn-historico" class="nav-btn">Historico</button>
    </nav>



        </header>

        <main>

            <section id="seccion-cargar" class="seccion-activa">
                <h2>Cargar Datos</h2>
                

                <div id="firebase-status" class="firebase-status" style="display: none;">
                    <span class="loading"></span> Conectando con Firebase...
                </div>
                

                <div id="estado-tabla" class="contador-lineas">
                    <span class="loading"></span> Cargando tabla de referencia...
                </div>
                
                <div class="form-group">
                    <label for="fecha">Fecha:</label>
                    <input type="date" id="fecha">
                </div>
                <div class="form-group">
                    <label for="texto-csv">Pegar lista de SIM completa:</label>
                    <textarea id="texto-csv" rows="15" placeholder="Pega aquí el contenido completo..."></textarea>
                    <div id="contador-lineas" class="contador-lineas"></div>
                </div>
                <button id="btn-cargar-datos">Generar Resumen</button>
                <div id="status"></div>
                <div id="auto-navigate" class="auto-navigate" style="display: none;"></div>
            </section>


            <section id="seccion-resumen" class="seccion-oculta">
                <h2>Resumen por Departamento</h2>
                <div class="date-selector">
                    <label for="fecha-resumen">Fecha:</label>
                    <input type="date" id="fecha-resumen">
                    <button id="btn-cargar-desde-firebase">Actualizar</button>
                </div>
                <div id="resumen-contenido" class="resumen-container">

                </div>
            </section>


            <section id="seccion-reporte" class="seccion-oculta">
                <h2>Generar Reporte PDF</h2>
                <div class="date-selector">
                    <label for="fecha-reporte">Fecha:</label>
                    <input type="date" id="fecha-reporte">
                   
                </div>
                <div class="form-group">
                    <label for="pasillo-reporte">Pasillo (opcional):</label>
                    <select id="pasillo-reporte">
                        <option value="">Todos los pasillos</option>

                    </select>
                </div>
                <button id="btn-generar-pdf">Generar Reporte PDF</button>
                <div id="progreso-reporte" style="display: none;">
                    <p>Generando reporte...</p>
                </div>
                <div id="resultado-reporte"></div>
            </section>


            <section id="seccion-historico" class="seccion-oculta">
                <h2>Cargar Datos Históricos</h2>
                <div class="form-group">
                    <label for="fecha-historico">Seleccionar Fecha:</label>
                    <input type="date" id="fecha-historico">
                </div>
                <button id="btn-cargar-historico">Cargar desde Firebase</button>
                <div id="estado-historico" style="margin-top: 20px;"></div>
            </section>
        </main>
    </div>

    <script>

        const MAPA_DEPARTAMENTOS = {
            "1": "Galletitas y Golosinas", "82": "Checkout", "92": "Almacen seco", "95": "Bebidas sin alcohol", "96": "Bebidas con alcohol",
            "2": "Perfumeria", "4": "Papeles", "8": "Mascotas", "13": "Quimicos", "26": "Bebes", "46": "Cosmeticos", "21": "AVES", "43": "Carne Vacuno",
            "78": "Pescadería Retail", "79": "Carne Retail", "83": "Pescaderia Costos", "86": "Panaderia retail", "93": "CERDO GRANJA", "98": "Panaderia costos",
            "84": "Prod. Secos y especias", "94": "Frutas y Verduras", "69": "Fiambreria", "80": "Quesos", "81": "Rotiseria y Deli", "90": "Lacteos",
            "91": "Congelados", "97": "Envasados", "23": "Caballeros", "24": "Ninos", "25": "Calzados", "27": "Medias y Soquetes", "28": "Bebes - Ropa",
            "30": "Ropa interior", "33": "Ninas", "34": "Damas", "3": "Libreria", "7": "Jugueteria", "9": "Deportes", "12": "Pintureria", "16": "Jardineria",
            "17": "Muebles", "29": "Bebes - Puericultura", "31": "Equipajes - Accesorios", "5": "Electronicos", "11": "Ferreteria", "15": "PEQ ELECTRO",
            "35": "CLIMATIZACION", "36": "LINEA BLANCA", "87": "Informatica & Mobile", "14": "Bazar", "18": "Navidad", "19": "Decoracion", "20": "Cocina y Bano",
            "22": "Blancos", "74": "Organizacion", "40": "Farmacia Venta Libre", "10": "Automotor", "37": "TLE servicio"
        };

        
const METADATA_TIENDAS = {
    "1057": { nombre: "Comodoro Rivadavia", distrital: "Rafael Ghirardi", region: "PATAGONIA", formato: "HCH", nombreFormato: "HiperChangoMas" },
    "3604": { nombre: "Paraná", distrital: "TBD Centro", region: "CENTRO", formato: "HCH", nombreFormato: "HiperChangoMas" },
    "1010": { nombre: "Córdoba Sur", distrital: "TBD Centro", region: "CENTRO", formato: "PM", nombreFormato: "PuntoMayorista" },
    "1099": { nombre: "Posadas II", distrital: "Horacio Tupponi", region: "NEA FRONTERA", formato: "CH", nombreFormato: "ChangoMas" },
    "1074": { nombre: "Goya (Ctes)", distrital: "Horacio Tupponi", region: "NEA", formato: "CH", nombreFormato: "ChangoMas" },
    "1018": { nombre: "Quilmes", distrital: "Ariel Konaszczuk", region: "ZONA SUR", formato: "PM", nombreFormato: "PuntoMayorista" },
    "1110": { nombre: "Claypole", distrital: "Ariel Konaszczuk", region: "ZONA SUR", formato: "CH", nombreFormato: "ChangoMas" },
    "1055": { nombre: "Villa Mercedes", distrital: "Adrian Vinagre", region: "CUYO", formato: "CH", nombreFormato: "ChangoMas" },
    "1078": { nombre: "Salta Tartagal", distrital: "Luciano Budman", region: "NOA FRONTERA", formato: "CH", nombreFormato: "ChangoMas" },
    "1046": { nombre: "Pergamino", distrital: "Sebastian Martinelli", region: "ZONA SCH", formato: "SCH", nombreFormato: "SuperChangoMas" },
    "1077": { nombre: "Gral Pico (La Pampa)", distrital: "Sebastian Martinelli", region: "BA Y PAMPA", formato: "CH", nombreFormato: "ChangoMas" },
    "1098": { nombre: "R.S. Peña, Chaco", distrital: "Horacio Tupponi", region: "NEA", formato: "CH", nombreFormato: "ChangoMas" },
    "1031": { nombre: "Jujuy", distrital: "Luciano Budman", region: "NOA FRONTERA", formato: "CH", nombreFormato: "ChangoMas" },
    "1043": { nombre: "Laferrere", distrital: "Ricardo Masilo", region: "ZONA OESTE", formato: "HCH", nombreFormato: "HiperChangoMas" },
    "1119": { nombre: "Moreno Derqui", distrital: "Ricardo Masilo", region: "ZONA OESTE", formato: "CH", nombreFormato: "ChangoMas" },
    "1058": { nombre: "Resistencia", distrital: "Horacio Tupponi", region: "NEA", formato: "HCH", nombreFormato: "HiperChangoMas" },
    "1061": { nombre: "Junín", distrital: "Sebastian Martinelli", region: "BA Y PAMPA", formato: "CH", nombreFormato: "ChangoMas" },
    "1108": { nombre: "Puerto Madryn", distrital: "Rafael Ghirardi", region: "PATAGONIA", formato: "CH", nombreFormato: "ChangoMas" },
    "1060": { nombre: "Fuerza Aérea (Cba)", distrital: "TBD Centro", region: "CENTRO", formato: "CH", nombreFormato: "ChangoMas" },
    "1007": { nombre: "La Rioja", distrital: "TBD Centro", region: "NOA 1", formato: "CH", nombreFormato: "ChangoMas" },
    "1030": { nombre: "José C Paz", distrital: "Ricardo Masilo", region: "ZONA SCH", formato: "SCH", nombreFormato: "SuperChangoMas" },
    "1111": { nombre: "San Pedro de Jujuy", distrital: "Luciano Budman", region: "NOA FRONTERA", formato: "CH", nombreFormato: "ChangoMas" },
    "1056": { nombre: "Villa Nueva", distrital: "TBD Centro", region: "CENTRO", formato: "CH", nombreFormato: "ChangoMas" },
    "1116": { nombre: "Moron", distrital: "Ricardo Masilo", region: "ZONA OESTE", formato: "CH", nombreFormato: "ChangoMas" },
    "1039": { nombre: "Paraná 2", distrital: "TBD Centro", region: "CENTRO", formato: "CH", nombreFormato: "ChangoMas" },
    "3601": { nombre: "La Plata", distrital: "Ariel Konaszczuk", region: "ZONA SUR", formato: "HCH", nombreFormato: "HiperChangoMas" },
    "1026": { nombre: "Catamarca", distrital: "TBD Centro", region: "NOA 1", formato: "CH", nombreFormato: "ChangoMas" },
    "1097": { nombre: "Donato Alvarez (Cba)", distrital: "TBD Centro", region: "CENTRO", formato: "CH", nombreFormato: "ChangoMas" },
    "1014": { nombre: "Lujan", distrital: "Ricardo Masilo", region: "ZONA NORTE", formato: "HCH", nombreFormato: "HiperChangoMas" },
    "1011": { nombre: "Salta", distrital: "Luciano Budman", region: "NOA 1", formato: "CH", nombreFormato: "ChangoMas" },
    "1054": { nombre: "Olavarría", distrital: "Sebastian Martinelli", region: "BA Y PAMPA", formato: "HCH", nombreFormato: "HiperChangoMas" },
    "1100": { nombre: "Santa Rosa (La Pampa) II", distrital: "Sebastian Martinelli", region: "BA Y PAMPA", formato: "CH", nombreFormato: "ChangoMas" },
    "1087": { nombre: "Pilar", distrital: "Ricardo Masilo", region: "ZONA NORTE", formato: "HCH", nombreFormato: "HiperChangoMas" },
    "1080": { nombre: "Santiago del Estero Sur", distrital: "Luciano Budman", region: "NOA 1", formato: "CH", nombreFormato: "ChangoMas" },
    "3606": { nombre: "Córdoba Este", distrital: "TBD Centro", region: "CENTRO", formato: "HCH", nombreFormato: "HiperChangoMas" },
    "1052": { nombre: "Oran", distrital: "Luciano Budman", region: "NOA FRONTERA", formato: "CH", nombreFormato: "ChangoMas" },
    "1024": { nombre: "Formosa", distrital: "Horacio Tupponi", region: "NEA FRONTERA", formato: "CH", nombreFormato: "ChangoMas" },
    "1028": { nombre: "Alte Brown", distrital: "Ariel Konaszczuk", region: "ZONA SUR", formato: "CH", nombreFormato: "ChangoMas" },
    "1114": { nombre: "Clorinda", distrital: "Horacio Tupponi", region: "NEA FRONTERA", formato: "CH", nombreFormato: "ChangoMas" },
    "1086": { nombre: "Formosa II", distrital: "Horacio Tupponi", region: "NEA FRONTERA", formato: "CH", nombreFormato: "ChangoMas" },
    "1059": { nombre: "Gonzalez Catán", distrital: "Ricardo Masilo", region: "ZONA OESTE", formato: "CH", nombreFormato: "ChangoMas" },
    "1029": { nombre: "Moreno", distrital: "Ricardo Masilo", region: "ZONA OESTE", formato: "CH", nombreFormato: "ChangoMas" },
    "1050": { nombre: "Lanús", distrital: "Ariel Konaszczuk", region: "ZONA SUR", formato: "CH", nombreFormato: "ChangoMas" },
    "2998": { nombre: "San Justo", distrital: "Ricardo Masilo", region: "ZONA OESTE", formato: "HCH", nombreFormato: "HiperChangoMas" },
    "2999": { nombre: "Avellaneda", distrital: "Ariel Konaszczuk", region: "ZONA SUR", formato: "HCH", nombreFormato: "HiperChangoMas" },
    "1015": { nombre: "Maipú", distrital: "Adrian Vinagre", region: "CUYO", formato: "CH", nombreFormato: "ChangoMas" },
    "3603": { nombre: "Santa Fe", distrital: "TBD Centro", region: "CENTRO", formato: "HCH", nombreFormato: "HiperChangoMas" },
    "1023": { nombre: "La Pampa", distrital: "Sebastian Martinelli", region: "BA Y PAMPA", formato: "CH", nombreFormato: "ChangoMas" },
    "1045": { nombre: "Hurlingham (AV. Vergara)", distrital: "Ricardo Masilo", region: "ZONA SCH", formato: "SCH", nombreFormato: "SuperChangoMas" },
    "3613": { nombre: "Mendoza", distrital: "Adrian Vinagre", region: "CUYO", formato: "HCH", nombreFormato: "HiperChangoMas" },
    "1004": { nombre: "San Fernando", distrital: "Ariel Konaszczuk", region: "ZONA NORTE", formato: "HCH", nombreFormato: "HiperChangoMas" },
    "1085": { nombre: "Corrientes (Av. Maipú)", distrital: "Horacio Tupponi", region: "NEA", formato: "CH", nombreFormato: "ChangoMas" },
    "1093": { nombre: "Comodoro Rivadavia Norte", distrital: "Rafael Ghirardi", region: "PATAGONIA", formato: "CH", nombreFormato: "ChangoMas" },
    "1067": { nombre: "San Martín (Mza)", distrital: "Adrian Vinagre", region: "CUYO", formato: "CH", nombreFormato: "ChangoMas" },
    "1042": { nombre: "Trelew", distrital: "Rafael Ghirardi", region: "PATAGONIA", formato: "CH", nombreFormato: "ChangoMas" },
    "1008": { nombre: "Corrientes", distrital: "Horacio Tupponi", region: "NEA", formato: "HCH", nombreFormato: "HiperChangoMas" },
    "1012": { nombre: "Santiago", distrital: "Luciano Budman", region: "NOA 1", formato: "CH", nombreFormato: "ChangoMas" },
    "1037": { nombre: "San Martin", distrital: "Ariel Konaszczuk", region: "ZONA SCH", formato: "SCH", nombreFormato: "SuperChangoMas" },
    "1115": { nombre: "General Roca", distrital: "Rafael Ghirardi", region: "PATAGONIA", formato: "CH", nombreFormato: "ChangoMas" },
    "1020": { nombre: "Tucumán", distrital: "Luciano Budman", region: "NOA 1", formato: "HCH", nombreFormato: "HiperChangoMas" },
    "1051": { nombre: "Posadas", distrital: "Horacio Tupponi", region: "NEA FRONTERA", formato: "CH", nombreFormato: "ChangoMas" },
    "1044": { nombre: "Hurlingham (AV. Villegas)", distrital: "Ricardo Masilo", region: "ZONA SCH", formato: "SCH", nombreFormato: "SuperChangoMas" },
    "1096": { nombre: "Caseros", distrital: "Ariel Konaszczuk", region: "ZONA NORTE", formato: "CH", nombreFormato: "ChangoMas" },
    "1016": { nombre: "Avellaneda 2", distrital: "Ariel Konaszczuk", region: "ZONA SUR", formato: "HCH", nombreFormato: "HiperChangoMas" },
    "1027": { nombre: "Mataderos", distrital: "Ariel Konaszczuk", region: "ZONA SCH", formato: "SCH", nombreFormato: "SuperChangoMas" },
    "3602": { nombre: "Bahía Blanca", distrital: "Sebastian Martinelli", region: "BA Y PAMPA", formato: "HCH", nombreFormato: "HiperChangoMas" },
    "1002": { nombre: "Rio IV", distrital: "TBD Centro", region: "CENTRO", formato: "HCH", nombreFormato: "HiperChangoMas" },
    "1003": { nombre: "San Luis", distrital: "Adrian Vinagre", region: "CUYO", formato: "HCH", nombreFormato: "HiperChangoMas" },
    "1005": { nombre: "Las Heras", distrital: "Adrian Vinagre", region: "CUYO", formato: "HCH", nombreFormato: "HiperChangoMas" },
    "3605": { nombre: "Córduba Oeste", distrital: "TBD Centro", region: "CENTRO", formato: "HCH", nombreFormato: "HiperChangoMas" },
    "1036": { nombre: "Moreno Shopping", distrital: "Ricardo Masilo", region: "ZONA SCH", formato: "SCH", nombreFormato: "SuperChangoMas" },
    "1084": { nombre: "San Vicente", distrital: "Ariel Konaszczuk", region: "ZONA SCH", formato: "SCH", nombreFormato: "SuperChangoMas" },
    "1075": { nombre: "Salta Fuerza Aérea", distrital: "Luciano Budman", region: "NOA 1", formato: "CH", nombreFormato: "ChangoMas" },
    "1013": { nombre: "Tigre", distrital: "Ariel Konaszczuk", region: "ZONA NORTE", formato: "CH", nombreFormato: "ChangoMas" },
    "1038": { nombre: "Cipolletti", distrital: "Rafael Ghirardi", region: "PATAGONIA", formato: "CH", nombreFormato: "ChangoMas" },
    "1032": { nombre: "Malvinas Arg", distrital: "Ricardo Masilo", region: "ZONA NORTE", formato: "CH", nombreFormato: "ChangoMas" },
    "1076": { nombre: "Lomas de Zamora", distrital: "Ariel Konaszczuk", region: "ZONA SUR", formato: "CH", nombreFormato: "ChangoMas" },
    "1068": { nombre: "Palmares (Mza)", distrital: "Adrian Vinagre", region: "CUYO", formato: "HCH", nombreFormato: "HiperChangoMas" },
    "1092": { nombre: "San Juan Norte", distrital: "Adrian Vinagre", region: "CUYO", formato: "CH", nombreFormato: "ChangoMas" },
    "1053": { nombre: "Viedma", distrital: "Sebastian Martinelli", region: "BA Y PAMPA", formato: "CH", nombreFormato: "ChangoMas" },
    "1035": { nombre: "3 de Febrero", distrital: "Ricardo Masilo", region: "ZONA NORTE", formato: "CH", nombreFormato: "ChangoMas" },
    "1106": { nombre: "Tuc. Ejército Del Norte", distrital: "Luciano Budman", region: "NOA 1", formato: "CH", nombreFormato: "ChangoMas" },
    "1081": { nombre: "Rawson San Juan", distrital: "Adrian Vinagre", region: "CUYO", formato: "CH", nombreFormato: "ChangoMas" },
    "3608": { nombre: "Neuquén", distrital: "Rafael Ghirardi", region: "PATAGONIA", formato: "HCH", nombreFormato: "HiperChangoMas" },
    "4001": { nombre: "Campana", distrital: "Ricardo Masilo", region: "ZONA SCH", formato: "SCH", nombreFormato: "SuperChangoMas" },
    "1088": { nombre: "Tuc. Concepción", distrital: "Luciano Budman", region: "NOA 1", formato: "CH", nombreFormato: "ChangoMas" },
    "1006": { nombre: "San Juan", distrital: "Adrian Vinagre", region: "CUYO", formato: "HCH", nombreFormato: "HiperChangoMas" },
    "2997": { nombre: "Grafa", distrital: "Ariel Konaszczuk", region: "ZONA NORTE", formato: "HCH", nombreFormato: "HiperChangoMas" },
    "1021": { nombre: "Neuquén 2", distrital: "Rafael Ghirardi", region: "PATAGONIA", formato: "CH", nombreFormato: "ChangoMas" },
    "1033": { nombre: "Rio Salí", distrital: "Luciano Budman", region: "NOA 1", formato: "CH", nombreFormato: "ChangoMas" },
    "1022": { nombre: "Bariloche", distrital: "Rafael Ghirardi", region: "PATAGONIA", formato: "CH", nombreFormato: "ChangoMas" },
    "1082": { nombre: "Tucumán (Av. Jujuy)", distrital: "Luciano Budman", region: "NOA 1", formato: "CH", nombreFormato: "ChangoMas" },
    "1017": { nombre: "La Tablada", distrital: "Ricardo Masilo", region: "ZONA OESTE", formato: "HCH", nombreFormato: "HiperChangoMas" }
};

function obtenerMetadataTienda(idTienda) {
    return METADATA_TIENDAS[idTienda] || { 
        nombre: `Tienda ${idTienda}`, 
        distrital: "No asignado", 
        region: "No asignada", 
        formato: "CH", 
        nombreFormato: "ChangoMas" 
    };
}


        let tablaReferencia = new Map();
        let tablaProductosCompleta = new Map();
        let datosCargados = {};
        let fechaActual = obtenerFechaActual();
        let firebaseReady = false;

let guardadoFirebaseEnProgreso = false;


        async function inicializarFirebase() {
            try {
                const statusEl = document.getElementById('firebase-status');
                statusEl.style.display = 'block';
                statusEl.innerHTML = '<span class="loading"></span> Conectando con Firebase...';
                

                await esperarFirebase();
                

                if (!window.firebase || !window.firebase.db) {
                    throw new Error('Firebase no se inicializó correctamente');
                }
                

                console.log('🔍 Probando conexión con Firestore...');
                const testCollection = window.firebase.collection(window.firebase.db, "test_connection");
                const testQuery = window.firebase.query(testCollection);
                
                try {
                    await window.firebase.getDocs(testQuery);
                    firebaseReady = true;
                    statusEl.className = 'firebase-status firebase-connected';
                    statusEl.innerHTML = '✅ Conectado a Firebase correctamente';
                    
                    setTimeout(() => {
                        statusEl.style.display = 'none';
                    }, 3000);
                    
                    console.log('✅ Firebase inicializado correctamente');
                    return true;
                } catch (firestoreError) {

                    if (firestoreError.code === 'permission-denied' || firestoreError.message.includes('permission')) {
                        throw new Error('PERMISSIONS_ERROR: ' + firestoreError.message);
                    } else {
                        throw firestoreError;
                    }
                }
                
            } catch (error) {
                console.warn('⚠️ Firebase no disponible:', error);
                const statusEl = document.getElementById('firebase-status');
                
                if (error.message.includes('PERMISSIONS_ERROR')) {
                    statusEl.className = 'firebase-status firebase-config';
                    statusEl.innerHTML = `
                        ⚠️ <strong>Configuración de Firestore requerida</strong><br>
                        <small style="display: block; margin-top: 8px;">
                        1. Ve a <a href="https://console.firebase.google.com/project/huecos-96c8c/firestore/rules" target="_blank" style="color: #856404; text-decoration: underline;">Firebase Console > Firestore > Reglas</a><br>
                        2. Reemplaza las reglas con:<br>
                        <code style="background: #fff; padding: 2px 4px; border-radius: 3px; display: inline-block; margin: 4px 0;">
                        allow read, write: if true;
                        </code><br>
                        3. Haz clic en "Publicar"<br>
                        4. Recarga esta página
                        </small>
                    `;
                } else {
                    statusEl.className = 'firebase-status firebase-error';
                    statusEl.innerHTML = '⚠️ Modo local: Firebase no disponible - Los datos se guardarán localmente';
                }
                
                firebaseReady = false;
                return false;
            }
        }


        function esperarFirebase() {
            return new Promise((resolve, reject) => {
                let intentos = 0;
                const maxIntentos = 50;
                
                const checkFirebase = () => {
                    intentos++;
                    if (window.firebase && window.firebase.db) {
                        resolve();
                    } else if (window.firebaseLoaded && intentos >= 10) {

                        resolve();
                    } else if (intentos >= maxIntentos) {
                        reject(new Error('Timeout: Firebase no se cargó en 5 segundos'));
                    } else {
                        setTimeout(checkFirebase, 100);
                    }
                };
                
                checkFirebase();
            });
        }

// REEMPLAZA completamente la función guardarEnFirebaseEnSegundoPlano con esta:
async function guardarEnFirebaseEnSegundoPlano(datosProcesados) {
    if (!firebaseReady) {
        console.log('⚠️ Firebase no disponible, solo guardando localmente');
        return false;
    }

    const idTienda = document.getElementById('select-tienda').value;
    if (!idTienda) {
        mostrarEstado("❌ Primero selecciona una tienda", "error");
        return false;
    }

    const metadataTienda = obtenerMetadataTienda(idTienda);
    guardadoFirebaseEnProgreso = true;
    
    try {
        console.log(`💾 Guardando datos para tienda ${idTienda}...`);
        const { db, collection, addDoc, setDoc, doc } = window.firebase;
        
        const fecha = datosProcesados.fecha;
        const productos = datosProcesados.productosConInfo || [];
        
        if (productos.length === 0) {
            console.log('⚠️ No hay productos para guardar');
            guardadoFirebaseEnProgreso = false;
            return false;
        }

        // NUEVA ESTRUCTURA: huecos_gondola/tienda_id_fecha
        const fechaDocRef = doc(db, "huecos_gondola", `${idTienda}_${fecha}`);
        
        await setDoc(fechaDocRef, {
            fecha: fecha,
            idTienda: idTienda,
            nombreTienda: metadataTienda.nombre,
            distrital: metadataTienda.distrital,
            region: metadataTienda.region,
            formato: metadataTienda.formato,
            nombreFormato: metadataTienda.nombreFormato,
            totalItems: datosProcesados.totalItems,
            lineasProcesadas: datosProcesados.lineasProcesadas,
            lineasTotales: datosProcesados.lineasTotales,
            departamentos: datosProcesados.departamentos,
            productosSinDepartamento: datosProcesados.productosSinDepartamento,
            timestamp: new Date().toISOString()
        });

        const productosCollectionRef = collection(fechaDocRef, "productos");
        
        const batchSize = 50;
        let productosGuardados = 0;
        
        for (let i = 0; i < productos.length; i += batchSize) {
            const batch = productos.slice(i, i + batchSize);
            
            for (const producto of batch) {
                await addDoc(productosCollectionRef, {
                    sku: producto.sku || '',
                    descripcion: producto.descripcion || '',
                    deptId: producto.deptId || '',
                    pasillo: producto.pasillo || '',
                    stock: producto.stock || 0,
                    upc: producto.upc || '',
                    idTienda: idTienda,
                    timestamp: new Date().toISOString()
                });
                productosGuardados++;
            }
            
            console.log(`✅ Lote ${Math.floor(i/batchSize) + 1} guardado: ${batch.length} productos`);
            
            if (productosGuardados % 200 === 0) {
                mostrarEstado(`⏳ Guardando en la nube... (${productosGuardados}/${productos.length})`, "processing");
            }
        }

        console.log(`✅ Datos guardados en Firebase: ${productos.length} productos para tienda ${idTienda}`);
        mostrarEstado(`✅ Datos guardados en la nube (${metadataTienda.nombre}): ${productos.length} productos`, "success");
        guardadoFirebaseEnProgreso = false;
        return true;
        
    } catch (error) {
        console.error('❌ Error guardando en Firebase:', error);
        guardadoFirebaseEnProgreso = false;
        
        if (error.code === 'permission-denied') {
            mostrarEstado('❌ Error de permisos al guardar en la nube', "error");
        } else {
            mostrarEstado(`❌ Error guardando en la nube: ${error.message}`, "error");
        }
        
        return false;
    }
}

       // REEMPLAZA completamente la función cargarDesdeFirebase con esta:
async function cargarDesdeFirebase(fecha) {
    if (!firebaseReady) {
        console.log('⚠️ Firebase no disponible, cargando desde almacenamiento local');
        return datosCargados[obtenerClaveLocal(fecha)] || null;
    }

    try {
        const idTienda = document.getElementById('select-tienda').value;
        if (!idTienda) {
            mostrarEstado("❌ Primero selecciona una tienda", "error");
            return null;
        }

        console.log(`📥 Cargando desde Firebase: Tienda ${idTienda}, Fecha ${fecha}`);
        const { db, collection, getDocs, doc, getDoc } = window.firebase;
        
        // NUEVA ESTRUCTURA: huecos_gondola/tienda_id_fecha
        const fechaDocRef = doc(db, "huecos_gondola", `${idTienda}_${fecha}`);
        const fechaDoc = await getDoc(fechaDocRef);
        
        if (!fechaDoc.exists()) {
            console.log(`📭 No hay datos para tienda ${idTienda} en fecha ${fecha}`);
            return null;
        }

        const datosFecha = fechaDoc.data();
        
        const productosCollectionRef = collection(fechaDocRef, "productos");
        const productosSnapshot = await getDocs(productosCollectionRef);
        const productosConInfo = [];
        
        productosSnapshot.forEach(doc => {
            productosConInfo.push(doc.data());
        });

        const datosCompletos = {
            ...datosFecha,
            productosConInfo: productosConInfo
        };

        console.log(`✅ Datos cargados: ${productosConInfo.length} productos para ${obtenerMetadataTienda(idTienda).nombre}`);
        return datosCompletos;
        
    } catch (error) {
        console.error('❌ Error cargando desde Firebase:', error);
        
        if (error.code === 'permission-denied') {
            mostrarEstado('❌ Error de permisos al cargar desde Firebase', "error");
        } else {
            mostrarEstado(`❌ Error cargando desde Firebase: ${error.message}`, "error");
        }
        
        return null;
    }
}
// AGREGA esta función para manejar el almacenamiento local
function obtenerClaveLocal(fecha) {
    const idTienda = document.getElementById('select-tienda').value;
    return idTienda ? `${idTienda}_${fecha}` : fecha;
}

        function obtenerFechaActual() {
            const ahora = new Date();
            const año = ahora.getFullYear();
            const mes = String(ahora.getMonth() + 1).padStart(2, '0');
            const dia = String(ahora.getDate()).padStart(2, '0');
            return `${año}-${mes}-${dia}`;
        }

        async function cargarTablaReferencia() {
            try {
                console.log('📥 Cargando tabla de referencia...');
                const estadoTabla = document.getElementById('estado-tabla');
                
                const response = await fetch('./data.csv');
                if (!response.ok) throw new Error(`Error HTTP: ${response.status}`);
                
                const csvText = await response.text();
                const lineas = csvText.split('\n').filter(linea => linea.trim() !== '');
                
                for (let i = 1; i < lineas.length; i++) {
                    const partes = lineas[i].split(',').map(p => p.trim().replace(/"/g, ''));
                    if (partes.length >= 6) {
                        const sku = partes[0];
                        const descripcion = partes[4];
                        const deptId = partes[2];
                        const pasillo = partes[3];
                        const upc = partes[5];
                        
                        if (sku && deptId) {
                            tablaReferencia.set(sku, deptId);
                            tablaProductosCompleta.set(sku, {
                                descripcion: descripcion,
                                deptId: deptId,
                                pasillo: pasillo,
                                upc: upc
                            });
                        }
                    }
                }
                
                console.log(`✅ Tabla de referencia cargada: ${tablaReferencia.size} SKUs`);
                estadoTabla.innerHTML = `✅ Tabla de referencia cargada: <strong>${tablaReferencia.size.toLocaleString()} SKUs</strong>`;
                
            } catch (error) {
                console.error('❌ Error cargando tabla de referencia:', error);
                document.getElementById('estado-tabla').innerHTML = `❌ Error cargando tabla: ${error.message}`;
            }
        }

        function formatoFechaDDMMYYYY(fechaISO) {
            const [anio, mes, dia] = fechaISO.split('-');
            return `${dia}-${mes}-${anio}`;
        }

        function mostrarSeccion(seccion) {
            console.log('🔍 Mostrando sección:', seccion);
            

            document.querySelectorAll('section').forEach(sec => {
                sec.classList.remove('seccion-activa');
                sec.classList.add('seccion-oculta');
            });
            

            const seccionElement = document.getElementById(`seccion-${seccion}`);
            if (seccionElement) {
                seccionElement.classList.remove('seccion-oculta');
                seccionElement.classList.add('seccion-activa');
            }
            

            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            

            const boton = document.getElementById(`btn-${seccion}`);
            if (boton) {
                boton.classList.add('active');
            }
        }

        function actualizarContadorLineas() {
    const texto = document.getElementById('texto-csv').value;
    const lineas = texto.split('\n').filter(linea => linea.trim() !== '');
    
    const contador = document.getElementById('contador-lineas');
    

    if (lineas.length > 0) {
        contador.textContent = lineas.length;
    } else {
        contador.textContent = '';
    }
}

        function normalizarSaltos(texto) {
            return texto
                .replace(/\r\n/g, '\n')
                .replace(/\r/g, '\n')
                .replace(/\n{2,}/g, '\n');
        }

        function obtenerDepartamentoDeProducto(sku) {
            return tablaReferencia.get(sku) || null;
        }

        function obtenerInfoCompletaProducto(sku) {
            return tablaProductosCompleta.get(sku) || null;
        }

        function obtenerNombreDepartamento(codigoDepto) {
            return MAPA_DEPARTAMENTOS[codigoDepto] || `Departamento ${codigoDepto}`;
        }

        async function procesarDatosCSV() {
            const fecha = document.getElementById('fecha').value;
            const textoCSV = document.getElementById('texto-csv').value;
            
            if (!fecha) {
                mostrarEstado("❌ Selecciona una fecha", "error");
                return;
            }
            
            if (!textoCSV.trim()) {
                mostrarEstado("❌ No hay datos CSV para procesar", "error");
                return;
            }

            if (tablaReferencia.size === 0) {
                mostrarEstado("❌ La tabla de referencia no está cargada", "error");
                return;
            }

            const csvNormalizado = normalizarSaltos(textoCSV);
            const lineas = csvNormalizado.split('\n').filter(linea => linea.trim() !== '');
            
            console.log(`🔍 Procesando ${lineas.length} líneas para fecha: ${fecha}`);

            try {
                mostrarEstado(`⏳ Procesando ${lineas.length} productos...`, "processing");
                document.getElementById('btn-cargar-datos').disabled = true;

                const departamentos = {};
                let totalItems = 0;
                let lineasProcesadas = 0;
                let productosSinDepartamento = [];
                let productosConInfo = [];


                const lineasDatos = lineas.slice(1);

                for (const linea of lineasDatos) {
                    const partes = linea.split(',').map(p => p.trim());
                    

                    if (partes.length >= 9) {
                        const sku = partes[0];
                        const stock = partes[7];
                        
                        if (sku && sku !== 'sku/item') {
                            const infoProducto = obtenerInfoCompletaProducto(sku);
                            
                            if (infoProducto) {
                                const codigoDepto = infoProducto.deptId;
                                const nombreDepto = obtenerNombreDepartamento(codigoDepto);
                                
                                if (!departamentos[codigoDepto]) {
                                    departamentos[codigoDepto] = {
                                        nombre: nombreDepto,
                                        cantidad: 0
                                    };
                                }
                                
                                departamentos[codigoDepto].cantidad += 1;
                                totalItems += 1;
                                lineasProcesadas++;


                                let stockNumero;
                                if (stock && !isNaN(stock) && stock.trim() !== '') {
                                    stockNumero = parseInt(stock);
                                } else {
                                    stockNumero = 0;
                                }


                                if (isNaN(stockNumero)) {
                                    stockNumero = 0;
                                }

                                productosConInfo.push({
                                    sku: sku,
                                    descripcion: infoProducto.descripcion,
                                    deptId: codigoDepto,
                                    pasillo: infoProducto.pasillo,
                                    upc: infoProducto.upc,
                                    stock: stockNumero
                                });

                            } else {
                                productosSinDepartamento.push(sku);
                            }
                        }
                    }
                }


                const idTienda = document.getElementById('select-tienda').value;
const metadataTienda = obtenerMetadataTienda(idTienda);

datosCargados[obtenerClaveLocal(fecha)] = {
    fecha: fecha,
    idTienda: idTienda,
    nombreTienda: metadataTienda.nombre,
    distrital: metadataTienda.distrital,
    region: metadataTienda.region,
    formato: metadataTienda.formato,
    nombreFormato: metadataTienda.nombreFormato,
    csv: csvNormalizado,
    lineasTotales: lineasDatos.length,
    lineasProcesadas: lineasProcesadas,
    departamentos: departamentos,
    totalItems: totalItems,
    productosSinDepartamento: productosSinDepartamento,
    productosConInfo: productosConInfo,
    timestamp: new Date().toISOString()
};

let guardadoEnFirebase = false;
if (firebaseReady) {

    guardarEnFirebaseEnSegundoPlano(datosCargados[obtenerClaveLocal(fecha)])
        .then(resultado => {
            guardadoEnFirebase = resultado;
            console.log('✅ Guardado en segundo plano completado');
        })
        .catch(error => {
            console.error('❌ Error en guardado segundo plano:', error);
        });
} else {
    console.log('⚠️ Firebase no disponible, solo guardando localmente');
}


                actualizarFechaReporte();

                let mensajeExito = `✅ ${lineasProcesadas} productos procesados - ${totalItems} items en ${Object.keys(departamentos).length} departamentos`;
if (productosSinDepartamento.length > 0) {
    mensajeExito += ` (${productosSinDepartamento.length} productos sin departamento)`;
}

if (firebaseReady) {
    mensajeExito += ` - 🔄 Guardando en la nube (segundo plano)`;
} else {
    mensajeExito += ` - 💾 Datos guardados localmente`;
}

                mostrarEstado(mensajeExito, "success");

setTimeout(() => {
    const link = document.getElementById('link-ver-resumen-flotante');
    if (link) {
        link.addEventListener('click', function(e) {
            e.preventDefault();
            mostrarSeccion('resumen');
            mostrarResumenDesdeDatosCargados();
        });
    }
}, 100);


setTimeout(() => {
    mostrarSeccion('resumen');
    document.getElementById('fecha-resumen').value = fecha;
    mostrarResumenDesdeDatosCargados();
}, 500); 

                document.getElementById('texto-csv').value = '';
                actualizarContadorLineas();
                
configurarPrevencionCierre();
configurarPrevencionNavegacion();
console.log('🛡️ Sistema de prevención de cierre configurado');

            } catch (error) {
                console.error('❌ Error procesando datos:', error);
                mostrarEstado("❌ Error: " + error.message, "error");
            } finally {
                document.getElementById('btn-cargar-datos').disabled = false;
            }
        }

        async function mostrarResumenDesdeDatosCargados() {
            const fechaResumen = document.getElementById('fecha-resumen').value;
            
            if (!fechaResumen) {
                mostrarEstado("❌ Selecciona una fecha para el resumen", "error");
                return;
            }

            let datosFecha = datosCargados[obtenerClaveLocal(fechaResumen)];
            

            if (!datosFecha) {
                mostrarEstado("⏳ Cargando datos desde Firebase...", "processing");
                datosFecha = await cargarDesdeFirebase(fechaResumen);
                
                if (datosFecha) {

                    datosCargados[obtenerClaveLocal(fechaResumen)] = datosFecha;
                    mostrarEstado("✅ Datos cargados desde Firebase", "success");
                } else {
                    mostrarResumenVacio(fechaResumen);
                    mostrarEstado("ℹ️ No hay datos cargados para esta fecha", "processing");
                    return;
                }
            }

            console.log('📊 Mostrando resumen para:', fechaResumen);
            mostrarResumenDepartamentos(datosFecha);
        }

        function mostrarResumenDepartamentos(datos) {
            const contenedor = document.getElementById('resumen-contenido');
            if (!contenedor) return;


            const fechaSelector = document.getElementById('fecha-resumen').value;
            const [anio, mes, dia] = fechaSelector.split('-');
            const fechaFormateada = `${dia}/${mes}/${anio}`;
            
            const departamentos = datos.departamentos;
            

            const deptosOrdenados = Object.keys(departamentos).sort((a, b) => {
                return departamentos[b].cantidad - departamentos[a].cantidad;
            });

            let tablaHTML = '';


            deptosOrdenados.forEach(codigoDepto => {
                const info = departamentos[codigoDepto];
                const nombreDepto = info.nombre;
                

                tablaHTML += `
                    <tr>
                        <td><strong>${codigoDepto}</strong></td>
                        <td>${nombreDepto}</td>
                        <td style="text-align: center;"><strong>${info.cantidad}</strong></td>
                    </tr>
                `;
            });

            let productosSinDeptoHTML = '';
            if (datos.productosSinDepartamento && datos.productosSinDepartamento.length > 0) {

                const lineasCSV = datos.csv.split('\n');
                

                const encabezadosDataCSV = "SKU ID,Clase DESC,Dept ID,Pasillo,SKU DESC,Código SKU ID,Clase ID CATEGORIA,División DESC,largo de codigo";
                const nombresCampos = encabezadosDataCSV.split(',');
                

                let lineasSinDepto = [encabezadosDataCSV]; 
                
                lineasCSV.slice(1).forEach(linea => {
                    const partes = linea.split(',').map(p => p.trim());
                    const sku = partes[0];
                    

                    if (sku && datos.productosSinDepartamento.includes(sku)) {

                        const lineaReconstruida = [
                            partes[0] || nombresCampos[0], // SKU ID
                            partes[1] || nombresCampos[1], // Clase DESC  
                            nombresCampos[2], // Dept ID (nombre del encabezado)
                            partes[2] || nombresCampos[3], // Pasillo
                            partes[1] || nombresCampos[4], // SKU DESC
                            partes[0] || nombresCampos[5], // Código SKU ID
                            nombresCampos[6], // Clase ID CATEGORIA (nombre del encabezado)
                            nombresCampos[7], // División DESC (nombre del encabezado)
                            partes[0] ? partes[0].length.toString() : nombresCampos[8] // largo de codigo
                        ].join(',');
                        
                        lineasSinDepto.push(lineaReconstruida);
                    }
                });
                
                productosSinDeptoHTML = `
                    <div style="margin-top: 30px; padding: 20px; background: #fff3cd; border-radius: 8px; border: 1px solid #ffeaa7;">
                        <h4 style="color: #856404; margin-bottom: 15px;">
                            ⚠️ Productos sin departamento asignado (${datos.productosSinDepartamento.length})
                        </h4>
                        
                        <div style="background: white; border: 1px solid #ddd; border-radius: 4px; padding: 15px;">
                            <pre style="margin: 0; font-family: monospace; font-size: 12px; line-height: 1.4; max-height: 400px; overflow-y: auto; white-space: pre-wrap;">
${lineasSinDepto.join('\n')}</pre>
                        </div>
                        
                        <div style="margin-top: 10px; font-size: 12px; color: #856404;">
                            <strong>Nota:</strong> Copia este CSV completo y pégalo en data.csv - Los campos que no teníamos información se rellenaron con los nombres de encabezado
                        </div>
                    </div>
                `;
            }

            const html = `
                <div class="resumen-header">
                    <div class="resumen-title">📊 Resumen de Huecos por Departamento</div>
                    <div class="resumen-date">${fechaFormateada}</div>
                </div>
                
                <div class="resumen-total">
                    <strong>Total general:</strong> ${datos.totalItems} items en ${deptosOrdenados.length} departamentos
                    ${datos.productosSinDepartamento && datos.productosSinDepartamento.length > 0 ? ` + ${datos.productosSinDepartamento.length} productos sin departamento` : ''}
                </div>

                <table class="resumen-table">
                    <thead>
                        <tr>
                            <th width="80">CÓDIGO</th>
                            <th>DEPARTAMENTO</th>
                            <th width="100">CANTIDAD</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${tablaHTML}
                    </tbody>
                </table>
                
                ${productosSinDeptoHTML}
                
                <div style="margin-top: 20px; padding: 10px; background: #f8f9fa; border-radius: 4px; font-size: 12px;">
                    <strong>Información del procesamiento:</strong> 
                    ${datos.lineasProcesadas} de ${datos.lineasTotales} productos procesados · 
                    Cargado: ${new Date(datos.timestamp).toLocaleTimeString()}
                </div>
            `;
            
            contenedor.innerHTML = html;
        }

        function mostrarResumenVacio(fecha) {
            const contenedor = document.getElementById('resumen-contenido');
            const [anio, mes, dia] = fecha.split('-');
            const fechaFormateada = `${dia}/${mes}/${anio}`;
            
            contenedor.innerHTML = `
                <div class="resumen-header">
                    <div class="resumen-title">📊 Resumen de Huecos por Departamento</div>
                    <div class="resumen-date">${fechaFormateada}</div>
                </div>
                <div style="text-align: center; padding: 40px; color: #666;">
                    <p>No hay datos cargados para esta fecha.</p>
                    <p>Ve a la sección "Cargar Datos" para procesar información.</p>
                </div>
            `;
        }

       function mostrarEstado(mensaje, tipo, duracion = 5000) {
    // Crear elemento de notificación
    const notificacion = document.createElement('div');
    notificacion.className = `notificacion-flotante notificacion-${tipo}`;
    notificacion.innerHTML = mensaje;
    

    document.body.appendChild(notificacion);
    

    setTimeout(() => {
        notificacion.style.animation = 'slideOut 0.3s ease';
        setTimeout(() => {
            if (notificacion.parentNode) {
                notificacion.parentNode.removeChild(notificacion);
            }
        }, 300);
    }, duracion);
    
    return notificacion;
}

function mostrarNotificacionNavegacion(mensaje, duracion = 8000) {
    const notificacion = document.createElement('div');
    notificacion.className = 'notificacion-flotante notificacion-warning';
    notificacion.innerHTML = mensaje;
    
    document.body.appendChild(notificacion);
    
    setTimeout(() => {
        notificacion.style.animation = 'slideOut 0.3s ease';
        setTimeout(() => {
            if (notificacion.parentNode) {
                notificacion.parentNode.removeChild(notificacion);
            }
        }, 300);
    }, duracion);
    
    return notificacion;
}
        function actualizarSelectorPasillos() {
            const selector = document.getElementById('pasillo-reporte');
            selector.innerHTML = '<option value="">Todos los pasillos</option>';
            
            const pasillosUnicos = new Set();
            
            // Recorrer todos los datos cargados para encontrar pasillos únicos
            Object.values(datosCargados).forEach(datos => {
                if (datos.productosConInfo) {
                    datos.productosConInfo.forEach(producto => {
                        if (producto.pasillo) {
                            pasillosUnicos.add(producto.pasillo);
                        }
                    });
                }
            });
            
            // Ordenar y agregar pasillos al selector
            Array.from(pasillosUnicos).sort().forEach(pasillo => {
                const option = document.createElement('option');
                option.value = pasillo;
                option.textContent = pasillo;
                selector.appendChild(option);
            });
        }

        function actualizarSelectorResumen() {
    const fechasCargadas = Object.keys(datosCargados);
    if (fechasCargadas.length > 0) {
        // Ordenar fechas de más reciente a más antigua
        fechasCargadas.sort().reverse();
        const ultimaClave = fechasCargadas[0];
        
        // EXTRAER SOLO LA FECHA de la clave
        const ultimaFecha = ultimaClave.includes('_') 
            ? ultimaClave.split('_')[1] 
            : ultimaClave;
            
        document.getElementById('fecha-resumen').value = ultimaFecha;
    }
}

        function actualizarFechaReporte() {
    const fechasCargadas = Object.keys(datosCargados);
    if (fechasCargadas.length > 0) {
        // Ordenar fechas de más reciente a más antigua
        fechasCargadas.sort().reverse();
        const ultimaClave = fechasCargadas[0];
        
        // EXTRAER SOLO LA FECHA de la clave (ej: "1092_2025-11-30" → "2025-11-30")
        const ultimaFecha = ultimaClave.includes('_') 
            ? ultimaClave.split('_')[1] 
            : ultimaClave;
            
        document.getElementById('fecha-reporte').value = ultimaFecha;
        console.log(`📅 Fecha de reporte actualizada a: ${ultimaFecha}`);
    } else {
        console.log('ℹ️ No hay fechas cargadas para actualizar el reporte');
    }
}

        async function cargarYMostrarDesdeFirebase() {
            const fechaResumen = document.getElementById('fecha-resumen').value;
            
            if (!fechaResumen) {
                mostrarEstado("❌ Selecciona una fecha", "error");
                return;
            }

            mostrarEstado("⏳ Cargando datos desde Firebase...", "processing");

            const datos = await cargarDesdeFirebase(fechaResumen);
            
            if (datos) {
                // Guardar en datos locales
                datosCargados[obtenerClaveLocal(fechaResumen)] = datos;
                mostrarResumenDepartamentos(datos);
                mostrarEstado("✅ Datos cargados desde Firebase", "success");
            } else {
                mostrarEstado("❌ No hay datos en Firebase para esta fecha", "error");
            }
        }

        async function cargarHistoricoDesdeFirebase() {
            const fecha = document.getElementById('fecha-historico').value;
            
            if (!fecha) {
                document.getElementById('estado-historico').innerHTML = 
                    '<div class="error">❌ Selecciona una fecha</div>';
                return;
            }

            document.getElementById('estado-historico').innerHTML = 
                '<div class="processing">⏳ Cargando datos desde Firebase...</div>';

            const datos = await cargarDesdeFirebase(fecha);
            
            if (datos) {
                // Guardar en datos locales
                datosCargados[obtenerClaveLocal(fecha)] = datos;
                document.getElementById('estado-historico').innerHTML = 
                    `<div class="success">
                        ✅ Datos cargados: ${datos.totalItems} productos<br>
                        <button onclick="mostrarSeccion('resumen'); document.getElementById('fecha-resumen').value='${fecha}'; mostrarResumenDesdeDatosCargados();" style="margin-top: 10px;">
                            Ver Resumen
                        </button>
                    </div>`;
            } else {
                document.getElementById('estado-historico').innerHTML = 
                    '<div class="error">❌ No hay datos en Firebase para esta fecha</div>';
            }
        }

        async function generarReportePDF() {
    const fechaReporteInput = document.getElementById('fecha-reporte').value;
    
    if (!fechaReporteInput) {
        mostrarEstado("❌ Selecciona una fecha para el reporte", "error");
        return;
    }

    // PRIMERO obtener los datos
    const datosFecha = datosCargados[obtenerClaveLocal(fechaReporteInput)];
    
    if (!datosFecha || !datosFecha.productosConInfo) {
        mostrarEstado("❌ No hay datos cargados para esta fecha", "error");
        return;
    }

    // LUEGO obtener la fecha real de los datos
    const fechaRealPDF = formatoFechaDDMMYYYY(datosFecha.fecha);
            try {
                const progreso = document.getElementById('progreso-reporte');
                const resultado = document.getElementById('resultado-reporte');
                progreso.style.display = 'block';
                resultado.innerHTML = '';
                progreso.innerHTML = '<p>🔄 Generando reporte PDF con códigos de barras optimizados...</p>';

                // Filtrar productos por pasillo si se especificó
                let productosFiltrados = datosFecha.productosConInfo;
                const pasilloFiltro = document.getElementById('pasillo-reporte').value;
                if (pasilloFiltro) {
                    productosFiltrados = productosFiltrados.filter(p => p.pasillo === pasilloFiltro);
                }

                console.log('📊 Productos para PDF:', productosFiltrados.length);
                
                // Agrupar productos por pasillo
                const productosPorPasillo = {};
                productosFiltrados.forEach(producto => {
                    const pasillo = producto.pasillo || 'SIN PASILLO';
                    if (!productosPorPasillo[pasillo]) {
                        productosPorPasillo[pasillo] = [];
                    }
                    productosPorPasillo[pasillo].push(producto);
                });

                // Crear PDF en orientación VERTICAL
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();

                // Configuración general
                const marginLeft = 5;
                const marginRight = 5;
                const marginTop = 10;
                const pageWidth = doc.internal.pageSize.getWidth();
                const usableWidth = pageWidth - marginLeft - marginRight;

                // Para cada pasillo
                Object.keys(productosPorPasillo).sort().forEach((pasillo, index) => {

                    if (index > 0) {
                        doc.addPage();
                    }

                    let currentY = marginTop;


                    doc.setFontSize(10);
                    doc.setFont(undefined, 'bold');
                   doc.text(`Reporte de Huecos en Góndola del ${fechaRealPDF}`, marginLeft, currentY);
                    currentY += 5;


                    doc.setFontSize(9);
                    doc.setFont(undefined, 'bold');
                    doc.text(`Pasillo: ${pasillo}`, marginLeft, currentY);
                    currentY += 4;

                    // Preparar datos para la tabla
                    const tableData = productosPorPasillo[pasillo].map(producto => {
                        const stockStr = producto.stock !== undefined && producto.stock !== null 
                            ? producto.stock.toString() 
                            : '0';
                        
                        return [
                            producto.deptId || '',
                            '', // Ajust. vacío
                            producto.sku,
                            producto.descripcion || '',
                            stockStr,
                            producto.upc || '',
                            '' // Columna para códigos de barras
                        ];
                    });

                    // CALCULAR ANCHOS OPTIMIZADOS - COLUMNA CÓDIGO BARRAS MÁS ANCHA
                    const totalUsableWidth = usableWidth - 2;
                    const columnWidths = {
                        0: 8,  // depto
                        1: 8,   // Aj.
                        2: 18,  // sku (ligeramente reducido)
                        3: 15,  // detalle (reducida para dar más espacio al código)
                        4: 10,  // disp (ligeramente reducido)
                        5: 22,  // Código (ligeramente reducido)
                        6: 90   // Cód Barras - SIGNIFICATIVAMENTE AUMENTADO
                    };


                    const totalDefinedWidth = Object.values(columnWidths).reduce((a, b) => a + b, 0);
                    const extraWidth = totalUsableWidth - totalDefinedWidth;
                    if (extraWidth > 0) {
                        columnWidths[3] += extraWidth;
                    }

                    console.log('📏 Distribución de anchos:', columnWidths);
                    console.log('📐 Ancho total definido:', totalDefinedWidth);
                    console.log('📐 Espacio extra para detalle:', extraWidth);


                    doc.autoTable({
                        startY: currentY,
                        head: [['depto', '*', 'sku', 'detalle', 'PI', 'Código', 'Cód Barras']],
                        body: tableData,
                        margin: { 
                            left: marginLeft, 
                            right: marginRight,
                            top: currentY
                        },
                        styles: { 
                            fontSize: 7,
                            cellPadding: 1.5,
                            minCellHeight: 14,
                            cellWidth: 'wrap',
                            lineColor: [255, 255, 255],
                            lineWidth: 0.1,
                            valign: 'middle'
                        },
                        headStyles: { 
                            fillColor: [44, 62, 80],
                            textColor: 255,
                            fontStyle: 'bold',
                            fontSize: 7,
                            cellPadding: 1.5,
                            minCellHeight: 14
                        },
                        bodyStyles: {
                            fontSize: 7,
                            cellPadding: 1.5,
                            minCellHeight: 14,
                            valign: 'middle'
                        },
                        alternateRowStyles: { 
                            fillColor: [250, 250, 250],
                            minCellHeight: 14
                        },
                        tableWidth: 'auto',
                        columnStyles: columnWidths,
                        rowPageBreak: 'avoid',
                        didParseCell: function(data) {
                            if (data.section === 'body') {
                                data.cell.minCellHeight = 14;
                            }
                        },
                        didDrawCell: function(data) {

                            if (data.section === 'body' && data.column.index === 6) {
                                const productoIndex = data.row.index;
                                const productosDelPasillo = productosPorPasillo[pasillo];
                                
                                if (!productosDelPasillo || productoIndex >= productosDelPasillo.length) {
                                    return;
                                }
                                
                                const producto = productosDelPasillo[productoIndex];
                                
                                if (!producto) {
                                    return;
                                }

                                // Determinar código para código de barras
                                const codigoBarras = (producto.upc && producto.upc.trim() !== '') 
                                    ? producto.upc 
                                    : (producto.sku || '');

                                if (!codigoBarras || codigoBarras.length < 8) {
                                    // Código muy corto para código de barras, mostrar texto
                                    doc.setFontSize(5);
                                    const textoMostrar = producto.sku || 'SIN CODIGO';
                                    const textWidth = doc.getTextWidth(textoMostrar);
                                    const textX = data.cell.x + (data.cell.width - textWidth) / 2;
                                    doc.text(textoMostrar, textX, data.cell.y + 7);
                                    return;
                                }

                                try {
                                    // Crear elemento canvas con alta resolución
                                    const canvas = document.createElement('canvas');
                                    const ctx = canvas.getContext('2d');
                                    
                                    // Configurar canvas con mayor resolución
                                    canvas.width = 400;
                                    canvas.height = 120;
                                    
                                    // Generar código de barras con parámetros óptimos
                                    JsBarcode(canvas, codigoBarras, {
                                        format: "EAN13",
                                        width: 2.2,
                                        height: 60,
                                        displayValue: false,
                                        fontSize: 0,
                                        margin: 12,
                                        background: "#ffffff",
                                        lineColor: "#000000"
                                    });

                                    const barcodeDataURL = canvas.toDataURL('image/png', 1.0);
                                    
                                    // Calcular posición centrada en celda
                                    const barcodeWidth = 32;
                                    const barcodeHeight = 10;
                                    const x = data.cell.x + (data.cell.width - barcodeWidth) / 2;
                                    const y = data.cell.y + (data.cell.height - barcodeHeight) / 2;
                                    
                                    // Agregar código de barras
                                    doc.addImage(barcodeDataURL, 'PNG', x, y, barcodeWidth, barcodeHeight);
                                    
                                    // DIBUJAR LÍNEAS BLANCAS - USANDO data.cell
                                    doc.setDrawColor(255, 255, 255);
                                    doc.setLineWidth(0.3);
                                    
                                    // Línea entre Código y Cód Barras
                                    doc.line(
                                        data.cell.x, 
                                        data.cell.y, 
                                        data.cell.x, 
                                        data.cell.y + data.cell.height
                                    );
                                    
                                    // Línea derecha de Cód Barras
                                    doc.line(
                                        data.cell.x + data.cell.width, 
                                        data.cell.y, 
                                        data.cell.x + data.cell.width, 
                                        data.cell.y + data.cell.height
                                    );
                                    
                                    console.log(`✅ Código de barras en celda de ${data.cell.width}mm`);
                                    
                                } catch (error) {
                                    console.error(`❌ Error generando código de barras para ${producto.sku}:`, error);
                                    // Fallback: mostrar texto
                                    if (data.cell) {
                                        doc.setFontSize(5);
                                        const textoMostrar = codigoBarras.length > 20 ? codigoBarras.substring(0, 20) + '...' : codigoBarras;
                                        const textWidth = doc.getTextWidth(textoMostrar);
                                        const textX = data.cell.x + (data.cell.width - textWidth) / 2;
                                        doc.text(textoMostrar, textX, data.cell.y + 7);
                                    }
                                }
                            }
                        },
                        tableLineWidth: 0.1,
                        tableLineColor: [255, 255, 255],
                        margin: { top: currentY, bottom: 10 },
                        pageBreak: 'auto'
                    });

                });

                // Guardar PDF
                const pdfBlob = doc.output('blob');
                const pdfUrl = URL.createObjectURL(pdfBlob);
                
                // Mostrar resultado
                progreso.style.display = 'none';
                mostrarEstado("✅ Reporte generado correctamente!", "success");
                // Auto-abrir en nueva pestaña para imprimir
                setTimeout(() => {
                    window.open(pdfUrl, '_blank');
                }, 1000);

            } catch (error) {
                console.error('❌ Error generando PDF:', error);
                mostrarEstado(`❌ Error generando PDF: ${error.message}`, "error");
            }
        }

        // INICIALIZACIÓN
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🔄 DOM cargado, iniciando aplicación...');
            inicializarApp();
        });

        async function inicializarApp() {
            console.log('🚀 Inicializando aplicación...');
            
            // Inicializar Firebase primero
            await inicializarFirebase();
            await cargarTablaReferencia();
            
            // Configurar fechas
            document.getElementById('fecha').value = fechaActual;
            document.getElementById('fecha-resumen').value = fechaActual;
            document.getElementById('fecha-reporte').value = fechaActual;
            document.getElementById('fecha-historico').value = fechaActual;
            
            // Configurar navegación
            document.getElementById('btn-cargar').addEventListener('click', () => mostrarSeccion('cargar'));
            document.getElementById('btn-resumen').addEventListener('click', () => {
                mostrarSeccion('resumen');
                actualizarSelectorResumen();
                mostrarResumenDesdeDatosCargados();
            });
            document.getElementById('btn-reporte').addEventListener('click', () => {
    mostrarSeccion('reporte');
    actualizarSelectorPasillos();
    // La fecha se actualiza automáticamente cuando cargas datos
});
            document.getElementById('btn-historico').addEventListener('click', () => mostrarSeccion('historico'));
            
            // Configurar eventos
            document.getElementById('btn-cargar-datos').addEventListener('click', procesarDatosCSV);
           
            document.getElementById('btn-cargar-desde-firebase').addEventListener('click', cargarYMostrarDesdeFirebase);
            
            document.getElementById('texto-csv').addEventListener('input', actualizarContadorLineas);
            
            document.getElementById('btn-generar-pdf').addEventListener('click', generarReportePDF);
            document.getElementById('btn-cargar-historico').addEventListener('click', cargarHistoricoDesdeFirebase);

            actualizarContadorLineas();
            console.log('✅ Aplicación inicializada correctamente');
        }

        // SISTEMA DE PREVENCIÓN DE CIERRE MIENTRAS GUARDA FIREBASE
function configurarPrevencionCierre() {
    window.addEventListener('beforeunload', function (e) {
        if (guardadoFirebaseEnProgreso) {
            // Mostrar advertencia personalizada
            const mensaje = '⚠️ Los datos aún se están guardando en la nube. Si sales ahora, no estarán disponibles para consultas futuras. ¿Seguro que quieres salir?';
            
            // Para navegadores modernos
            e.preventDefault();
            e.returnValue = mensaje;
            
            // Para navegadores más antiguos
            return mensaje;
        }
    });
}

// También prevenir navegación interna
function configurarPrevencionNavegacion() {
    // Interceptar clics en enlaces de navegación
    document.addEventListener('click', function(e) {
        if (guardadoFirebaseEnProgreso) {
            const target = e.target;
            
            // Verificar si es un enlace de navegación interna
            if (target.tagName === 'A' && target.getAttribute('href') && 
                !target.getAttribute('href').startsWith('http') &&
                !target.getAttribute('href').startsWith('#')) {
                
                if (!confirm('⚠️ Los datos aún se están guardando en la nube. Si navegas ahora, no estarán disponibles para consultas futuras. ¿Seguro que quieres continuar?')) {
                    e.preventDefault();
                    return false;
                }
            }
        }
    });
}
    </script>
</body>
</html>