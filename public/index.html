<!DOCTYPE html>
<html lang="es">
<head>
    <link rel="icon" type="image/png" href="fav.png">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Huecos en Góndola</title>
    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
    
    <!-- Firebase SDK -->
    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs, query, where, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        
        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBvL_rQFZf8427SuBG8Ua_7YNlNY9kclZ4",
            authDomain: "huecos-96c8c.firebaseapp.com",
            projectId: "huecos-96c8c",
            storageBucket: "huecos-96c8c.firebasestorage.app",
            messagingSenderId: "545038530680",
            appId: "1:545038530680:web:8a3bfdc4334a0ea0b4d58d",
            measurementId: "G-0YDTR33E5S"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        
        // Make Firebase available globally
        window.firebase = { 
            db, 
            collection, 
            addDoc, 
            getDocs, 
            query, 
            where, 
            doc, 
            setDoc, 
            getDoc 
        };
        
        console.log('🔥 Firebase SDK cargado correctamente');
        
        // Marcar que Firebase está listo
        window.firebaseLoaded = true;
    </script>

    <style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --accent-color: #e74c3c;
            --light-color: #ecf0f1;
            --dark-color: #34495e;
            --success-color: #2ecc71;
            --warning-color: #f39c12;
            --border-radius: 8px;
            --box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #f5f7fa;
            color: #333;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            background-color: var(--primary-color);
            color: white;
            padding: 20px;
            border-radius: var(--border-radius);
            margin-bottom: 30px;
            box-shadow: var(--box-shadow);
        }
        
        h1 {
            text-align: center;
            margin-bottom: 20px;
            font-size: 28px;
        }
        
        nav {
            display: flex;
            justify-content: center;
            gap: 15px;
            flex-wrap: wrap;
        }
        
        .nav-btn {
            background-color: var(--dark-color);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
        }
        
        .nav-btn:hover {
            background-color: var(--secondary-color);
            transform: translateY(-2px);
        }
        
        .nav-btn.active {
            background-color: var(--secondary-color);
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }
        
        main {
            background-color: white;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            padding: 30px;
            min-height: 500px;
        }
        
        section {
            display: none;
        }
        
        .seccion-activa {
            display: block;
            animation: fadeIn 0.5s ease;
        }
        
        .seccion-oculta {
            display: none;
        }
        
        h2 {
            color: var(--primary-color);
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--light-color);
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--dark-color);
        }
        
        input, select, textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: var(--border-radius);
            font-size: 16px;
            transition: border 0.3s;
        }
        
        input:focus, select:focus, textarea:focus {
            border-color: var(--secondary-color);
            outline: none;
            box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2);
        }
        
        textarea {
            min-height: 200px;
            font-family: monospace;
            font-size: 11px;
            resize: vertical;
        }
        
        button:not(.nav-btn) {
            background-color: var(--secondary-color);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        
        button:not(.nav-btn):hover {
            background-color: #2980b9;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        
        #status {
    position: fixed;
    top: 20px;
    right: 20px;
    z-index: 1000;
    padding: 15px 20px;
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    max-width: 400px;
    font-weight: 600;
    animation: slideIn 0.3s ease;
}

@keyframes slideIn {
    from {
        transform: translateX(100%);
        opacity: 0;
    }
    to {
        transform: translateX(0);
        opacity: 1;
    }
}
        
       .success {
    background-color: #d4edda;
    color: #155724;
    border: 1px solid #c3e6cb;
}

.error {
    background-color: #f8d7da;
    color: #721c24;
    border: 1px solid #f5c6cb;
}

.processing {
    background-color: #cce7ff;
    color: #004085;
    border: 1px solid #b3d7ff;
}
        
        .date-selector {
            display: flex;
            gap: 15px;
            align-items: center;
            margin-bottom: 25px;
            flex-wrap: wrap;
        }
        
        .date-selector input {
            width: auto;
        }
        
        .resumen-container {
            background-color: #f8f9fa;
            border-radius: var(--border-radius);
            padding: 20px;
            box-shadow: inset 0 0 5px rgba(0, 0, 0, 0.05);
        }
        
        .resumen-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .resumen-title {
            font-size: 24px;
            color: var(--primary-color);
            font-weight: bold;
        }
        
        .resumen-date {
            font-size: 16px;
            color: var(--dark-color);
        }
        
        .resumen-total {
            font-size: 18px;
            margin-bottom: 20px;
            color: var(--dark-color);
        }
        
        .resumen-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            background: white;
        }
        
        .resumen-table th, .resumen-table td {
            padding: 12px 15px;
            text-align: left;
            border: 1px solid #ddd;
        }
        
        .resumen-table th {
            background-color: #f2f2f2;
            font-weight: bold;
            color: var(--primary-color);
        }
        
        .resumen-table tr:nth-child(even) {
            background-color: #f8f9fa;
        }
        
        .resumen-table tr:hover {
            background-color: #e9ecef;
        }
        
        .contador-lineas {
            margin-top: 10px;
            font-size: 14px;
            color: var(--dark-color);
        }
        
        .auto-navigate {
    position: fixed;
    top: 80px; /* Debajo del primer mensaje */
    right: 20px;
    z-index: 999;
    padding: 15px 20px;
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    max-width: 400px;
    background-color: #e8f4fd;
    color: #004085;
    border: 1px solid #b3d7ff;
    animation: slideIn 0.3s ease;
}
        
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .firebase-status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            font-size: 14px;
        }
        
        .firebase-connected {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .firebase-error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .firebase-config {
            background-color: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        
        @media (max-width: 768px) {
            nav {
                flex-direction: column;
            }
            
            .date-selector {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .date-selector input, .date-selector button {
                width: 100%;
            }
            
            .resumen-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
        }

        .contador-lineas {
    font-size: 14px;
    font-weight: bold;
    color: #2c3e50;
    margin-top: 5px;
    text-align: right;
    padding: 2px 8px;
    background-color: #f8f9fa;
    border-radius: 4px;
    display: inline-block;
}
    </style>
    
    <!-- Incluir jsPDF y autoTable -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
</head>

<body>
    <div class="container">
        <header>
            <h1>Sistema de Huecos en Góndola</h1>
            <nav>
                <button id="btn-cargar" class="nav-btn active">Cargar Datos</button>
                <button id="btn-resumen" class="nav-btn">Ver Resumen</button>
                <button id="btn-reporte" class="nav-btn">Generar Reporte</button>
                <button id="btn-historico" class="nav-btn">Cargar Histórico</button>
            </nav>
        </header>

        <main>
            <!-- Sección Cargar Datos -->
            <section id="seccion-cargar" class="seccion-activa">
                <h2>Cargar Datos CSV</h2>
                
                <!-- Estado de Firebase -->
                <div id="firebase-status" class="firebase-status" style="display: none;">
                    <span class="loading"></span> Conectando con Firebase...
                </div>
                
                <!-- Estado de carga de la tabla referencia -->
                <div id="estado-tabla" class="contador-lineas">
                    <span class="loading"></span> Cargando tabla de referencia...
                </div>
                
                <div class="form-group">
                    <label for="fecha">Fecha:</label>
                    <input type="date" id="fecha">
                </div>
                <div class="form-group">
                    <label for="texto-csv">Pegar CSV completo:</label>
                    <textarea id="texto-csv" rows="15" placeholder="Pega aquí el contenido completo del CSV..."></textarea>
                    <div id="contador-lineas" class="contador-lineas"></div>
                </div>
                <button id="btn-cargar-datos">Procesar CSV</button>
                <div id="status"></div>
                <div id="auto-navigate" class="auto-navigate" style="display: none;">
                    <p>✅ Datos procesados correctamente. <a href="#" id="link-ver-resumen">Ver resumen ahora</a> o espera 3 segundos...</p>
                </div>
            </section>

            <!-- Sección Resumen -->
            <section id="seccion-resumen" class="seccion-oculta">
                <h2>Resumen por Departamento</h2>
                <div class="date-selector">
                    <label for="fecha-resumen">Fecha:</label>
                    <input type="date" id="fecha-resumen">
                    <button id="btn-actualizar-resumen">Actualizar</button>
                    <button id="btn-cargar-desde-firebase">Cargar desde Firebase</button>
                </div>
                <div id="resumen-contenido" class="resumen-container">
                    <!-- Aquí se cargará el resumen dinámicamente -->
                </div>
            </section>

            <!-- Sección Reporte -->
            <section id="seccion-reporte" class="seccion-oculta">
                <h2>Generar Reporte PDF</h2>
                <div class="date-selector">
                    <label for="fecha-reporte">Fecha:</label>
                    <input type="date" id="fecha-reporte">
                    <button id="btn-actualizar-reporte">Actualizar</button>
                </div>
                <div class="form-group">
                    <label for="pasillo-reporte">Pasillo (opcional):</label>
                    <select id="pasillo-reporte">
                        <option value="">Todos los pasillos</option>
                        <!-- Se llenará dinámicamente -->
                    </select>
                </div>
                <button id="btn-generar-pdf">Generar Reporte PDF</button>
                <div id="progreso-reporte" style="display: none;">
                    <p>Generando reporte...</p>
                </div>
                <div id="resultado-reporte"></div>
            </section>

            <!-- Nueva Sección: Cargar Histórico -->
            <section id="seccion-historico" class="seccion-oculta">
                <h2>Cargar Datos Históricos</h2>
                <div class="form-group">
                    <label for="fecha-historico">Seleccionar Fecha:</label>
                    <input type="date" id="fecha-historico">
                </div>
                <button id="btn-cargar-historico">Cargar desde Firebase</button>
                <div id="estado-historico" style="margin-top: 20px;"></div>
            </section>
        </main>
    </div>

    <script>
        // CONFIGURACIÓN
        const MAPA_DEPARTAMENTOS = {
            "1": "Galletitas y Golosinas", "82": "Checkout", "92": "Almacen seco", "95": "Bebidas sin alcohol", "96": "Bebidas con alcohol",
            "2": "Perfumeria", "4": "Papeles", "8": "Mascotas", "13": "Quimicos", "26": "Bebes", "46": "Cosmeticos", "21": "AVES", "43": "Carne Vacuno",
            "78": "Pescadería Retail", "79": "Carne Retail", "83": "Pescaderia Costos", "86": "Panaderia retail", "93": "CERDO GRANJA", "98": "Panaderia costos",
            "84": "Prod. Secos y especias", "94": "Frutas y Verduras", "69": "Fiambreria", "80": "Quesos", "81": "Rotiseria y Deli", "90": "Lacteos",
            "91": "Congelados", "97": "Envasados", "23": "Caballeros", "24": "Ninos", "25": "Calzados", "27": "Medias y Soquetes", "28": "Bebes - Ropa",
            "30": "Ropa interior", "33": "Ninas", "34": "Damas", "3": "Libreria", "7": "Jugueteria", "9": "Deportes", "12": "Pintureria", "16": "Jardineria",
            "17": "Muebles", "29": "Bebes - Puericultura", "31": "Equipajes - Accesorios", "5": "Electronicos", "11": "Ferreteria", "15": "PEQ ELECTRO",
            "35": "CLIMATIZACION", "36": "LINEA BLANCA", "87": "Informatica & Mobile", "14": "Bazar", "18": "Navidad", "19": "Decoracion", "20": "Cocina y Bano",
            "22": "Blancos", "74": "Organizacion", "40": "Farmacia Venta Libre", "10": "Automotor", "37": "TLE servicio"
        };

        // Variables globales
        let tablaReferencia = new Map();
        let tablaProductosCompleta = new Map();
        let datosCargados = {};
        let fechaActual = obtenerFechaActual();
        let firebaseReady = false;
        // NUEVA VARIABLE: Control de guardado en segundo plano
let guardadoFirebaseEnProgreso = false;

        // FUNCIONES FIREBASE - CORREGIDAS
        async function inicializarFirebase() {
            try {
                const statusEl = document.getElementById('firebase-status');
                statusEl.style.display = 'block';
                statusEl.innerHTML = '<span class="loading"></span> Conectando con Firebase...';
                
                // Esperar a que Firebase esté disponible
                await esperarFirebase();
                
                // Verificar que Firebase esté disponible
                if (!window.firebase || !window.firebase.db) {
                    throw new Error('Firebase no se inicializó correctamente');
                }
                
                // Intentar una operación simple de lectura
                console.log('🔍 Probando conexión con Firestore...');
                const testCollection = window.firebase.collection(window.firebase.db, "test_connection");
                const testQuery = window.firebase.query(testCollection);
                
                try {
                    await window.firebase.getDocs(testQuery);
                    firebaseReady = true;
                    statusEl.className = 'firebase-status firebase-connected';
                    statusEl.innerHTML = '✅ Conectado a Firebase correctamente';
                    
                    setTimeout(() => {
                        statusEl.style.display = 'none';
                    }, 3000);
                    
                    console.log('✅ Firebase inicializado correctamente');
                    return true;
                } catch (firestoreError) {
                    // Error específico de Firestore (probablemente permisos)
                    if (firestoreError.code === 'permission-denied' || firestoreError.message.includes('permission')) {
                        throw new Error('PERMISSIONS_ERROR: ' + firestoreError.message);
                    } else {
                        throw firestoreError;
                    }
                }
                
            } catch (error) {
                console.warn('⚠️ Firebase no disponible:', error);
                const statusEl = document.getElementById('firebase-status');
                
                if (error.message.includes('PERMISSIONS_ERROR')) {
                    statusEl.className = 'firebase-status firebase-config';
                    statusEl.innerHTML = `
                        ⚠️ <strong>Configuración de Firestore requerida</strong><br>
                        <small style="display: block; margin-top: 8px;">
                        1. Ve a <a href="https://console.firebase.google.com/project/huecos-96c8c/firestore/rules" target="_blank" style="color: #856404; text-decoration: underline;">Firebase Console > Firestore > Reglas</a><br>
                        2. Reemplaza las reglas con:<br>
                        <code style="background: #fff; padding: 2px 4px; border-radius: 3px; display: inline-block; margin: 4px 0;">
                        allow read, write: if true;
                        </code><br>
                        3. Haz clic en "Publicar"<br>
                        4. Recarga esta página
                        </small>
                    `;
                } else {
                    statusEl.className = 'firebase-status firebase-error';
                    statusEl.innerHTML = '⚠️ Modo local: Firebase no disponible - Los datos se guardarán localmente';
                }
                
                firebaseReady = false;
                return false;
            }
        }

        // Función para esperar a que Firebase esté disponible
        function esperarFirebase() {
            return new Promise((resolve, reject) => {
                let intentos = 0;
                const maxIntentos = 50;
                
                const checkFirebase = () => {
                    intentos++;
                    if (window.firebase && window.firebase.db) {
                        resolve();
                    } else if (window.firebaseLoaded && intentos >= 10) {
                        // Si Firebase marcó que se cargó pero no está disponible
                        resolve();
                    } else if (intentos >= maxIntentos) {
                        reject(new Error('Timeout: Firebase no se cargó en 5 segundos'));
                    } else {
                        setTimeout(checkFirebase, 100);
                    }
                };
                
                checkFirebase();
            });
        }

       // FUNCIÓN MEJORADA: Guardar en Firebase en segundo plano (no bloqueante)
async function guardarEnFirebaseEnSegundoPlano(datosProcesados) {
    if (!firebaseReady) {
        console.log('⚠️ Firebase no disponible, solo guardando localmente');
        return false;
    }

    // Marcar que el guardado está en progreso
    guardadoFirebaseEnProgreso = true;
    
    // Mostrar indicador de guardado en segundo plano
    mostrarEstado("⏳ Guardando en la nube (segundo plano)...", "processing");
    
    try {
        console.log('💾 Iniciando guardado en segundo plano en Firebase...');
        const { db, collection, addDoc, setDoc, doc } = window.firebase;
        
        const fecha = datosProcesados.fecha;
        const productos = datosProcesados.productosConInfo || [];
        
        if (productos.length === 0) {
            console.log('⚠️ No hay productos para guardar');
            guardadoFirebaseEnProgreso = false;
            return false;
        }

        // Crear documento principal para la fecha
        const fechaDocRef = doc(db, "huecos_gondola", fecha);
        await setDoc(fechaDocRef, {
            fecha: fecha,
            totalItems: datosProcesados.totalItems,
            lineasProcesadas: datosProcesados.lineasProcesadas,
            lineasTotales: datosProcesados.lineasTotales,
            departamentos: datosProcesados.departamentos,
            productosSinDepartamento: datosProcesados.productosSinDepartamento,
            timestamp: new Date().toISOString()
        });

        // Guardar productos en subcolección
        const productosCollectionRef = collection(fechaDocRef, "productos");
        
        // Guardar productos en lotes más pequeños para mayor estabilidad
        const batchSize = 50;
        let productosGuardados = 0;
        
        for (let i = 0; i < productos.length; i += batchSize) {
            const batch = productos.slice(i, i + batchSize);
            
            // Guardar uno por uno para mejor manejo de errores
            for (const producto of batch) {
                await addDoc(productosCollectionRef, {
                    sku: producto.sku || '',
                    descripcion: producto.descripcion || '',
                    deptId: producto.deptId || '',
                    pasillo: producto.pasillo || '',
                    stock: producto.stock || 0,
                    upc: producto.upc || '',
                    timestamp: new Date().toISOString()
                });
                productosGuardados++;
            }
            
            console.log(`✅ Lote ${Math.floor(i/batchSize) + 1} guardado: ${batch.length} productos`);
            
            // Actualizar estado periódicamente
            if (productosGuardados % 200 === 0) {
                mostrarEstado(`⏳ Guardando en la nube... (${productosGuardados}/${productos.length})`, "processing");
            }
        }

        console.log(`✅ Datos guardados en Firebase: ${productos.length} productos`);
        mostrarEstado(`✅ Datos guardados en la nube: ${productos.length} productos`, "success");
        guardadoFirebaseEnProgreso = false;
        return true;
        
    } catch (error) {
        console.error('❌ Error guardando en Firebase:', error);
        guardadoFirebaseEnProgreso = false;
        
        if (error.code === 'permission-denied') {
            mostrarEstado('❌ Error de permisos al guardar en la nube', "error");
        } else {
            mostrarEstado(`❌ Error guardando en la nube: ${error.message}`, "error");
        }
        
        return false;
    }
}

        async function cargarDesdeFirebase(fecha) {
            if (!firebaseReady) {
                console.log('⚠️ Firebase no disponible, cargando desde almacenamiento local');
                return datosCargados[fecha] || null;
            }

            try {
                console.log(`📥 Cargando desde Firebase para fecha: ${fecha}`);
                const { db, collection, getDocs, doc, getDoc } = window.firebase;
                
                const fechaDocRef = doc(db, "huecos_gondola", fecha);
                const fechaDoc = await getDoc(fechaDocRef);
                
                if (!fechaDoc.exists()) {
                    console.log('📭 No hay datos en Firebase para esta fecha');
                    return null;
                }

                // Cargar datos principales
                const datosFecha = fechaDoc.data();
                
                // Cargar productos de la subcolección
                const productosCollectionRef = collection(fechaDocRef, "productos");
                const productosSnapshot = await getDocs(productosCollectionRef);
                const productosConInfo = [];
                
                productosSnapshot.forEach(doc => {
                    productosConInfo.push(doc.data());
                });

                // Reconstruir el objeto de datos completo
                const datosCompletos = {
                    ...datosFecha,
                    productosConInfo: productosConInfo
                };

                console.log(`✅ Datos cargados desde Firebase: ${productosConInfo.length} productos`);
                return datosCompletos;
                
            } catch (error) {
                console.error('❌ Error cargando desde Firebase:', error);
                
                if (error.code === 'permission-denied') {
                    mostrarEstado('❌ Error de permisos al cargar desde Firebase', "error");
                } else {
                    mostrarEstado(`❌ Error cargando desde Firebase: ${error.message}`, "error");
                }
                
                return null;
            }
        }

        // FUNCIONES PRINCIPALES
        function obtenerFechaActual() {
            const ahora = new Date();
            const año = ahora.getFullYear();
            const mes = String(ahora.getMonth() + 1).padStart(2, '0');
            const dia = String(ahora.getDate()).padStart(2, '0');
            return `${año}-${mes}-${dia}`;
        }

        async function cargarTablaReferencia() {
            try {
                console.log('📥 Cargando tabla de referencia...');
                const estadoTabla = document.getElementById('estado-tabla');
                
                const response = await fetch('./data.csv');
                if (!response.ok) throw new Error(`Error HTTP: ${response.status}`);
                
                const csvText = await response.text();
                const lineas = csvText.split('\n').filter(linea => linea.trim() !== '');
                
                for (let i = 1; i < lineas.length; i++) {
                    const partes = lineas[i].split(',').map(p => p.trim().replace(/"/g, ''));
                    if (partes.length >= 6) {
                        const sku = partes[0];
                        const descripcion = partes[4];
                        const deptId = partes[2];
                        const pasillo = partes[3];
                        const upc = partes[5];
                        
                        if (sku && deptId) {
                            tablaReferencia.set(sku, deptId);
                            tablaProductosCompleta.set(sku, {
                                descripcion: descripcion,
                                deptId: deptId,
                                pasillo: pasillo,
                                upc: upc
                            });
                        }
                    }
                }
                
                console.log(`✅ Tabla de referencia cargada: ${tablaReferencia.size} SKUs`);
                estadoTabla.innerHTML = `✅ Tabla de referencia cargada: <strong>${tablaReferencia.size.toLocaleString()} SKUs</strong>`;
                
            } catch (error) {
                console.error('❌ Error cargando tabla de referencia:', error);
                document.getElementById('estado-tabla').innerHTML = `❌ Error cargando tabla: ${error.message}`;
            }
        }

        function formatoFechaDDMMYYYY(fechaISO) {
            const [anio, mes, dia] = fechaISO.split('-');
            return `${dia}-${mes}-${anio}`;
        }

        function mostrarSeccion(seccion) {
            console.log('🔍 Mostrando sección:', seccion);
            
            // Ocultar todas las secciones
            document.querySelectorAll('section').forEach(sec => {
                sec.classList.remove('seccion-activa');
                sec.classList.add('seccion-oculta');
            });
            
            // Mostrar la sección seleccionada
            const seccionElement = document.getElementById(`seccion-${seccion}`);
            if (seccionElement) {
                seccionElement.classList.remove('seccion-oculta');
                seccionElement.classList.add('seccion-activa');
            }
            
            // Actualizar botones de navegación
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Activar el botón correspondiente
            const boton = document.getElementById(`btn-${seccion}`);
            if (boton) {
                boton.classList.add('active');
            }
        }

        function actualizarContadorLineas() {
    const texto = document.getElementById('texto-csv').value;
    const lineas = texto.split('\n').filter(linea => linea.trim() !== '');
    
    const contador = document.getElementById('contador-lineas');
    
    // Mostrar solo el número de líneas
    if (lineas.length > 0) {
        contador.textContent = lineas.length;
    } else {
        contador.textContent = '';
    }
}

        function normalizarSaltos(texto) {
            return texto
                .replace(/\r\n/g, '\n')
                .replace(/\r/g, '\n')
                .replace(/\n{2,}/g, '\n');
        }

        function obtenerDepartamentoDeProducto(sku) {
            return tablaReferencia.get(sku) || null;
        }

        function obtenerInfoCompletaProducto(sku) {
            return tablaProductosCompleta.get(sku) || null;
        }

        function obtenerNombreDepartamento(codigoDepto) {
            return MAPA_DEPARTAMENTOS[codigoDepto] || `Departamento ${codigoDepto}`;
        }

        async function procesarDatosCSV() {
            const fecha = document.getElementById('fecha').value;
            const textoCSV = document.getElementById('texto-csv').value;
            
            if (!fecha) {
                mostrarEstado("❌ Selecciona una fecha", "error");
                return;
            }
            
            if (!textoCSV.trim()) {
                mostrarEstado("❌ No hay datos CSV para procesar", "error");
                return;
            }

            if (tablaReferencia.size === 0) {
                mostrarEstado("❌ La tabla de referencia no está cargada", "error");
                return;
            }

            const csvNormalizado = normalizarSaltos(textoCSV);
            const lineas = csvNormalizado.split('\n').filter(linea => linea.trim() !== '');
            
            console.log(`🔍 Procesando ${lineas.length} líneas para fecha: ${fecha}`);

            try {
                mostrarEstado(`⏳ Procesando ${lineas.length} productos...`, "processing");
                document.getElementById('btn-cargar-datos').disabled = true;

                const departamentos = {};
                let totalItems = 0;
                let lineasProcesadas = 0;
                let productosSinDepartamento = [];
                let productosConInfo = [];

                // Saltar la primera línea (encabezados)
                const lineasDatos = lineas.slice(1);

                for (const linea of lineasDatos) {
                    const partes = linea.split(',').map(p => p.trim());
                    
                    // Verificar que tenga suficientes columnas para el stock (posición 7)
                    if (partes.length >= 9) {
                        const sku = partes[0];
                        const stock = partes[7];
                        
                        if (sku && sku !== 'sku/item') {
                            const infoProducto = obtenerInfoCompletaProducto(sku);
                            
                            if (infoProducto) {
                                const codigoDepto = infoProducto.deptId;
                                const nombreDepto = obtenerNombreDepartamento(codigoDepto);
                                
                                if (!departamentos[codigoDepto]) {
                                    departamentos[codigoDepto] = {
                                        nombre: nombreDepto,
                                        cantidad: 0
                                    };
                                }
                                
                                departamentos[codigoDepto].cantidad += 1;
                                totalItems += 1;
                                lineasProcesadas++;

                                // CONVERSIÓN ROBUSTA DEL STOCK
                                let stockNumero;
                                if (stock && !isNaN(stock) && stock.trim() !== '') {
                                    stockNumero = parseInt(stock);
                                } else {
                                    stockNumero = 0;
                                }

                                // Validar que sea un número válido
                                if (isNaN(stockNumero)) {
                                    stockNumero = 0;
                                }

                                productosConInfo.push({
                                    sku: sku,
                                    descripcion: infoProducto.descripcion,
                                    deptId: codigoDepto,
                                    pasillo: infoProducto.pasillo,
                                    upc: infoProducto.upc,
                                    stock: stockNumero
                                });

                            } else {
                                productosSinDepartamento.push(sku);
                            }
                        }
                    }
                }

                // Guardar datos procesados
                datosCargados[fecha] = {
                    fecha: fecha,
                    csv: csvNormalizado,
                    lineasTotales: lineasDatos.length,
                    lineasProcesadas: lineasProcesadas,
                    departamentos: departamentos,
                    totalItems: totalItems,
                    productosSinDepartamento: productosSinDepartamento,
                    productosConInfo: productosConInfo,
                    timestamp: new Date().toISOString()
                };

                // NUEVO: Guardar en Firebase
                // NUEVO: Guardar en Firebase EN SEGUNDO PLANO (no bloqueante)
let guardadoEnFirebase = false;
if (firebaseReady) {
    // Iniciar guardado en segundo plano sin await
    guardarEnFirebaseEnSegundoPlano(datosCargados[fecha])
        .then(resultado => {
            guardadoEnFirebase = resultado;
            console.log('✅ Guardado en segundo plano completado');
        })
        .catch(error => {
            console.error('❌ Error en guardado segundo plano:', error);
        });
} else {
    console.log('⚠️ Firebase no disponible, solo guardando localmente');
}

                // ACTUALIZAR FECHA DEL REPORTE AUTOMÁTICAMENTE
                actualizarFechaReporte();

                let mensajeExito = `✅ ${lineasProcesadas} productos procesados - ${totalItems} items en ${Object.keys(departamentos).length} departamentos`;
if (productosSinDepartamento.length > 0) {
    mensajeExito += ` (${productosSinDepartamento.length} productos sin departamento)`;
}

if (firebaseReady) {
    mensajeExito += ` - 🔄 Guardando en la nube (segundo plano)`;
} else {
    mensajeExito += ` - 💾 Datos guardados localmente`;
}

                mostrarEstado(mensajeExito, "success");

                const autoNavigateEl = document.getElementById('auto-navigate');
autoNavigateEl.style.display = 'block';
setTimeout(() => {
    autoNavigateEl.style.display = 'none';
}, 8000);

// Navegación INMEDIATA (no esperar 3 segundos)
setTimeout(() => {
    mostrarSeccion('resumen');
    document.getElementById('fecha-resumen').value = fecha;
    mostrarResumenDesdeDatosCargados();
}, 500); // Reducido a 0.5 segundos para mayor velocidad

                document.getElementById('texto-csv').value = '';
                actualizarContadorLineas();
                // Configurar sistemas de prevención
configurarPrevencionCierre();
configurarPrevencionNavegacion();
console.log('🛡️ Sistema de prevención de cierre configurado');

            } catch (error) {
                console.error('❌ Error procesando datos:', error);
                mostrarEstado("❌ Error: " + error.message, "error");
            } finally {
                document.getElementById('btn-cargar-datos').disabled = false;
            }
        }

        async function mostrarResumenDesdeDatosCargados() {
            const fechaResumen = document.getElementById('fecha-resumen').value;
            
            if (!fechaResumen) {
                mostrarEstado("❌ Selecciona una fecha para el resumen", "error");
                return;
            }

            let datosFecha = datosCargados[fechaResumen];
            
            // NUEVO: Si no hay datos locales, intentar cargar desde Firebase
            if (!datosFecha) {
                mostrarEstado("⏳ Cargando datos desde Firebase...", "processing");
                datosFecha = await cargarDesdeFirebase(fechaResumen);
                
                if (datosFecha) {
                    // Guardar en datos locales para uso futuro
                    datosCargados[fechaResumen] = datosFecha;
                    mostrarEstado("✅ Datos cargados desde Firebase", "success");
                } else {
                    mostrarResumenVacio(fechaResumen);
                    mostrarEstado("ℹ️ No hay datos cargados para esta fecha", "processing");
                    return;
                }
            }

            console.log('📊 Mostrando resumen para:', fechaResumen);
            mostrarResumenDepartamentos(datosFecha);
        }

        function mostrarResumenDepartamentos(datos) {
            const contenedor = document.getElementById('resumen-contenido');
            if (!contenedor) return;

            // USAR LA FECHA DEL SELECTOR, NO LA DE LOS DATOS
            const fechaSelector = document.getElementById('fecha-resumen').value;
            const [anio, mes, dia] = fechaSelector.split('-');
            const fechaFormateada = `${dia}/${mes}/${anio}`;
            
            const departamentos = datos.departamentos;
            
            // Ordenar departamentos por cantidad (mayor a menor)
            const deptosOrdenados = Object.keys(departamentos).sort((a, b) => {
                return departamentos[b].cantidad - departamentos[a].cantidad;
            });

            let tablaHTML = '';

            // Generar tabla
            deptosOrdenados.forEach(codigoDepto => {
                const info = departamentos[codigoDepto];
                const nombreDepto = info.nombre;
                
                // Tabla
                tablaHTML += `
                    <tr>
                        <td><strong>${codigoDepto}</strong></td>
                        <td>${nombreDepto}</td>
                        <td style="text-align: center;"><strong>${info.cantidad}</strong></td>
                    </tr>
                `;
            });

            let productosSinDeptoHTML = '';
            if (datos.productosSinDepartamento && datos.productosSinDepartamento.length > 0) {
                // Obtener todas las líneas del CSV original que pegó el usuario
                const lineasCSV = datos.csv.split('\n');
                
                // Encabezados de data.csv (estructura objetivo)
                const encabezadosDataCSV = "SKU ID,Clase DESC,Dept ID,Pasillo,SKU DESC,Código SKU ID,Clase ID CATEGORIA,División DESC,largo de codigo";
                const nombresCampos = encabezadosDataCSV.split(',');
                
                // Filtrar y reconstruir las líneas con la estructura de data.csv
                let lineasSinDepto = [encabezadosDataCSV]; // Empezar con los encabezados de data.csv
                
                lineasCSV.slice(1).forEach(linea => {
                    const partes = linea.split(',').map(p => p.trim());
                    const sku = partes[0];
                    
                    // Verificar si este SKU está en la lista de productos sin departamento
                    if (sku && datos.productosSinDepartamento.includes(sku)) {
                        // Reconstruir la línea con la estructura de data.csv
                        // Los campos vacíos se reemplazan por el nombre del encabezado
                        const lineaReconstruida = [
                            partes[0] || nombresCampos[0], // SKU ID
                            partes[1] || nombresCampos[1], // Clase DESC  
                            nombresCampos[2], // Dept ID (nombre del encabezado)
                            partes[2] || nombresCampos[3], // Pasillo
                            partes[1] || nombresCampos[4], // SKU DESC
                            partes[0] || nombresCampos[5], // Código SKU ID
                            nombresCampos[6], // Clase ID CATEGORIA (nombre del encabezado)
                            nombresCampos[7], // División DESC (nombre del encabezado)
                            partes[0] ? partes[0].length.toString() : nombresCampos[8] // largo de codigo
                        ].join(',');
                        
                        lineasSinDepto.push(lineaReconstruida);
                    }
                });
                
                productosSinDeptoHTML = `
                    <div style="margin-top: 30px; padding: 20px; background: #fff3cd; border-radius: 8px; border: 1px solid #ffeaa7;">
                        <h4 style="color: #856404; margin-bottom: 15px;">
                            ⚠️ Productos sin departamento asignado (${datos.productosSinDepartamento.length})
                        </h4>
                        
                        <div style="background: white; border: 1px solid #ddd; border-radius: 4px; padding: 15px;">
                            <pre style="margin: 0; font-family: monospace; font-size: 12px; line-height: 1.4; max-height: 400px; overflow-y: auto; white-space: pre-wrap;">
${lineasSinDepto.join('\n')}</pre>
                        </div>
                        
                        <div style="margin-top: 10px; font-size: 12px; color: #856404;">
                            <strong>Nota:</strong> Copia este CSV completo y pégalo en data.csv - Los campos que no teníamos información se rellenaron con los nombres de encabezado
                        </div>
                    </div>
                `;
            }

            const html = `
                <div class="resumen-header">
                    <div class="resumen-title">📊 Resumen de Huecos por Departamento</div>
                    <div class="resumen-date">${fechaFormateada}</div>
                </div>
                
                <div class="resumen-total">
                    <strong>Total general:</strong> ${datos.totalItems} items en ${deptosOrdenados.length} departamentos
                    ${datos.productosSinDepartamento && datos.productosSinDepartamento.length > 0 ? ` + ${datos.productosSinDepartamento.length} productos sin departamento` : ''}
                </div>

                <table class="resumen-table">
                    <thead>
                        <tr>
                            <th width="80">CÓDIGO</th>
                            <th>DEPARTAMENTO</th>
                            <th width="100">CANTIDAD</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${tablaHTML}
                    </tbody>
                </table>
                
                ${productosSinDeptoHTML}
                
                <div style="margin-top: 20px; padding: 10px; background: #f8f9fa; border-radius: 4px; font-size: 12px;">
                    <strong>Información del procesamiento:</strong> 
                    ${datos.lineasProcesadas} de ${datos.lineasTotales} productos procesados · 
                    Cargado: ${new Date(datos.timestamp).toLocaleTimeString()}
                </div>
            `;
            
            contenedor.innerHTML = html;
        }

        function mostrarResumenVacio(fecha) {
            const contenedor = document.getElementById('resumen-contenido');
            const [anio, mes, dia] = fecha.split('-');
            const fechaFormateada = `${dia}/${mes}/${anio}`;
            
            contenedor.innerHTML = `
                <div class="resumen-header">
                    <div class="resumen-title">📊 Resumen de Huecos por Departamento</div>
                    <div class="resumen-date">${fechaFormateada}</div>
                </div>
                <div style="text-align: center; padding: 40px; color: #666;">
                    <p>No hay datos cargados para esta fecha.</p>
                    <p>Ve a la sección "Cargar Datos" para procesar información.</p>
                </div>
            `;
        }

        function mostrarEstado(mensaje, tipo) {
    const statusEl = document.getElementById('status');
    if (statusEl) {
        statusEl.innerHTML = mensaje;
        statusEl.className = tipo;
        statusEl.style.display = 'block';
        
        // Ocultar automáticamente después de 5 segundos para todos los tipos
        setTimeout(() => {
            statusEl.style.display = 'none';
        }, 5000);
    }
}

        function actualizarSelectorPasillos() {
            const selector = document.getElementById('pasillo-reporte');
            selector.innerHTML = '<option value="">Todos los pasillos</option>';
            
            const pasillosUnicos = new Set();
            
            // Recorrer todos los datos cargados para encontrar pasillos únicos
            Object.values(datosCargados).forEach(datos => {
                if (datos.productosConInfo) {
                    datos.productosConInfo.forEach(producto => {
                        if (producto.pasillo) {
                            pasillosUnicos.add(producto.pasillo);
                        }
                    });
                }
            });
            
            // Ordenar y agregar pasillos al selector
            Array.from(pasillosUnicos).sort().forEach(pasillo => {
                const option = document.createElement('option');
                option.value = pasillo;
                option.textContent = pasillo;
                selector.appendChild(option);
            });
        }

        function actualizarSelectorResumen() {
            const fechasCargadas = Object.keys(datosCargados);
            if (fechasCargadas.length > 0) {
                // Ordenar fechas de más reciente a más antigua
                fechasCargadas.sort().reverse();
                const ultimaFecha = fechasCargadas[0];
                document.getElementById('fecha-resumen').value = ultimaFecha;
            }
        }

        function actualizarFechaReporte() {
            const fechasCargadas = Object.keys(datosCargados);
            if (fechasCargadas.length > 0) {
                // Ordenar fechas de más reciente a más antigua
                fechasCargadas.sort().reverse();
                const ultimaFecha = fechasCargadas[0];
                document.getElementById('fecha-reporte').value = ultimaFecha;
                console.log(`📅 Fecha de reporte actualizada a: ${ultimaFecha}`);
            } else {
                console.log('ℹ️ No hay fechas cargadas para actualizar el reporte');
            }
        }

        async function cargarYMostrarDesdeFirebase() {
            const fechaResumen = document.getElementById('fecha-resumen').value;
            
            if (!fechaResumen) {
                mostrarEstado("❌ Selecciona una fecha", "error");
                return;
            }

            mostrarEstado("⏳ Cargando datos desde Firebase...", "processing");

            const datos = await cargarDesdeFirebase(fechaResumen);
            
            if (datos) {
                // Guardar en datos locales
                datosCargados[fechaResumen] = datos;
                mostrarResumenDepartamentos(datos);
                mostrarEstado("✅ Datos cargados desde Firebase", "success");
            } else {
                mostrarEstado("❌ No hay datos en Firebase para esta fecha", "error");
            }
        }

        async function cargarHistoricoDesdeFirebase() {
            const fecha = document.getElementById('fecha-historico').value;
            
            if (!fecha) {
                document.getElementById('estado-historico').innerHTML = 
                    '<div class="error">❌ Selecciona una fecha</div>';
                return;
            }

            document.getElementById('estado-historico').innerHTML = 
                '<div class="processing">⏳ Cargando datos desde Firebase...</div>';

            const datos = await cargarDesdeFirebase(fecha);
            
            if (datos) {
                // Guardar en datos locales
                datosCargados[fecha] = datos;
                document.getElementById('estado-historico').innerHTML = 
                    `<div class="success">
                        ✅ Datos cargados: ${datos.totalItems} productos<br>
                        <button onclick="mostrarSeccion('resumen'); document.getElementById('fecha-resumen').value='${fecha}'; mostrarResumenDesdeDatosCargados();" style="margin-top: 10px;">
                            Ver Resumen
                        </button>
                    </div>`;
            } else {
                document.getElementById('estado-historico').innerHTML = 
                    '<div class="error">❌ No hay datos en Firebase para esta fecha</div>';
            }
        }

        async function generarReportePDF() {
            const fechaReporteInput = document.getElementById('fecha-reporte').value;
            
            if (!fechaReporteInput) {
                mostrarEstado("❌ Selecciona una fecha para el reporte", "error");
                return;
            }

            // Convertir fecha de YYYY-MM-DD a DD-MM-YYYY para el PDF
            const fechaReportePDF = formatoFechaDDMMYYYY(fechaReporteInput);

            // Buscar datos para la fecha del reporte
            const datosFecha = datosCargados[fechaReporteInput];
            
            if (!datosFecha || !datosFecha.productosConInfo) {
                mostrarEstado("❌ No hay datos cargados para esta fecha", "error");
                return;
            }

            try {
                const progreso = document.getElementById('progreso-reporte');
                const resultado = document.getElementById('resultado-reporte');
                progreso.style.display = 'block';
                resultado.innerHTML = '';
                progreso.innerHTML = '<p>🔄 Generando reporte PDF con códigos de barras optimizados...</p>';

                // Filtrar productos por pasillo si se especificó
                let productosFiltrados = datosFecha.productosConInfo;
                const pasilloFiltro = document.getElementById('pasillo-reporte').value;
                if (pasilloFiltro) {
                    productosFiltrados = productosFiltrados.filter(p => p.pasillo === pasilloFiltro);
                }

                console.log('📊 Productos para PDF:', productosFiltrados.length);
                
                // Agrupar productos por pasillo
                const productosPorPasillo = {};
                productosFiltrados.forEach(producto => {
                    const pasillo = producto.pasillo || 'SIN PASILLO';
                    if (!productosPorPasillo[pasillo]) {
                        productosPorPasillo[pasillo] = [];
                    }
                    productosPorPasillo[pasillo].push(producto);
                });

                // Crear PDF en orientación VERTICAL
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();

                // Configuración general
                const marginLeft = 5;
                const marginRight = 5;
                const marginTop = 10;
                const pageWidth = doc.internal.pageSize.getWidth();
                const usableWidth = pageWidth - marginLeft - marginRight;

                // Para cada pasillo
                Object.keys(productosPorPasillo).sort().forEach((pasillo, index) => {
                    // Salto de página si no es el primer pasillo
                    if (index > 0) {
                        doc.addPage();
                    }

                    let currentY = marginTop;

                    // Título principal COMPACTO
                    doc.setFontSize(10);
                    doc.setFont(undefined, 'bold');
                    doc.text(`Reporte de Huecos en Góndola del ${fechaReportePDF}`, marginLeft, currentY);
                    currentY += 5;

                    // Título del pasillo COMPACTO
                    doc.setFontSize(9);
                    doc.setFont(undefined, 'bold');
                    doc.text(`Pasillo: ${pasillo}`, marginLeft, currentY);
                    currentY += 4;

                    // Preparar datos para la tabla
                    const tableData = productosPorPasillo[pasillo].map(producto => {
                        const stockStr = producto.stock !== undefined && producto.stock !== null 
                            ? producto.stock.toString() 
                            : '0';
                        
                        return [
                            producto.deptId || '',
                            '', // Ajust. vacío
                            producto.sku,
                            producto.descripcion || '',
                            stockStr,
                            producto.upc || '',
                            '' // Columna para códigos de barras
                        ];
                    });

                    // CALCULAR ANCHOS OPTIMIZADOS - COLUMNA CÓDIGO BARRAS MÁS ANCHA
                    const totalUsableWidth = usableWidth - 2;
                    const columnWidths = {
                        0: 8,  // depto
                        1: 8,   // Aj.
                        2: 18,  // sku (ligeramente reducido)
                        3: 15,  // detalle (reducida para dar más espacio al código)
                        4: 10,  // disp (ligeramente reducido)
                        5: 22,  // Código (ligeramente reducido)
                        6: 90   // Cód Barras - SIGNIFICATIVAMENTE AUMENTADO
                    };

                    // Ajustar dinámicamente el ancho de "detalle" con lo que sobra
                    const totalDefinedWidth = Object.values(columnWidths).reduce((a, b) => a + b, 0);
                    const extraWidth = totalUsableWidth - totalDefinedWidth;
                    if (extraWidth > 0) {
                        columnWidths[3] += extraWidth;
                    }

                    console.log('📏 Distribución de anchos:', columnWidths);
                    console.log('📐 Ancho total definido:', totalDefinedWidth);
                    console.log('📐 Espacio extra para detalle:', extraWidth);

                    // Generar tabla con COLUMNA CÓDIGO BARRAS MÁS ANCHA
                    doc.autoTable({
                        startY: currentY,
                        head: [['depto', 'Aj.', 'sku', 'detalle', 'disp', 'Código', 'Cód Barras']],
                        body: tableData,
                        margin: { 
                            left: marginLeft, 
                            right: marginRight,
                            top: currentY
                        },
                        styles: { 
                            fontSize: 7,
                            cellPadding: 1.5,
                            minCellHeight: 14,
                            cellWidth: 'wrap',
                            lineColor: [255, 255, 255],
                            lineWidth: 0.1,
                            valign: 'middle'
                        },
                        headStyles: { 
                            fillColor: [44, 62, 80],
                            textColor: 255,
                            fontStyle: 'bold',
                            fontSize: 7,
                            cellPadding: 1.5,
                            minCellHeight: 14
                        },
                        bodyStyles: {
                            fontSize: 7,
                            cellPadding: 1.5,
                            minCellHeight: 14,
                            valign: 'middle'
                        },
                        alternateRowStyles: { 
                            fillColor: [250, 250, 250],
                            minCellHeight: 14
                        },
                        tableWidth: 'auto',
                        columnStyles: columnWidths,
                        rowPageBreak: 'avoid',
                        didParseCell: function(data) {
                            if (data.section === 'body') {
                                data.cell.minCellHeight = 14;
                            }
                        },
                        didDrawCell: function(data) {
                            // Solo procesar celdas del cuerpo en la columna de códigos de barras
                            if (data.section === 'body' && data.column.index === 6) {
                                const productoIndex = data.row.index;
                                const productosDelPasillo = productosPorPasillo[pasillo];
                                
                                if (!productosDelPasillo || productoIndex >= productosDelPasillo.length) {
                                    return;
                                }
                                
                                const producto = productosDelPasillo[productoIndex];
                                
                                if (!producto) {
                                    return;
                                }

                                // Determinar código para código de barras
                                const codigoBarras = (producto.upc && producto.upc.trim() !== '') 
                                    ? producto.upc 
                                    : (producto.sku || '');

                                if (!codigoBarras || codigoBarras.length < 8) {
                                    // Código muy corto para código de barras, mostrar texto
                                    doc.setFontSize(5);
                                    const textoMostrar = producto.sku || 'SIN CODIGO';
                                    const textWidth = doc.getTextWidth(textoMostrar);
                                    const textX = data.cell.x + (data.cell.width - textWidth) / 2;
                                    doc.text(textoMostrar, textX, data.cell.y + 7);
                                    return;
                                }

                                try {
                                    // Crear elemento canvas con alta resolución
                                    const canvas = document.createElement('canvas');
                                    const ctx = canvas.getContext('2d');
                                    
                                    // Configurar canvas con mayor resolución
                                    canvas.width = 400;
                                    canvas.height = 120;
                                    
                                    // Generar código de barras con parámetros óptimos
                                    JsBarcode(canvas, codigoBarras, {
                                        format: "EAN13",
                                        width: 2.2,
                                        height: 60,
                                        displayValue: false,
                                        fontSize: 0,
                                        margin: 12,
                                        background: "#ffffff",
                                        lineColor: "#000000"
                                    });

                                    const barcodeDataURL = canvas.toDataURL('image/png', 1.0);
                                    
                                    // Calcular posición centrada en celda
                                    const barcodeWidth = 32;
                                    const barcodeHeight = 10;
                                    const x = data.cell.x + (data.cell.width - barcodeWidth) / 2;
                                    const y = data.cell.y + (data.cell.height - barcodeHeight) / 2;
                                    
                                    // Agregar código de barras
                                    doc.addImage(barcodeDataURL, 'PNG', x, y, barcodeWidth, barcodeHeight);
                                    
                                    // DIBUJAR LÍNEAS BLANCAS - USANDO data.cell
                                    doc.setDrawColor(255, 255, 255);
                                    doc.setLineWidth(0.3);
                                    
                                    // Línea entre Código y Cód Barras
                                    doc.line(
                                        data.cell.x, 
                                        data.cell.y, 
                                        data.cell.x, 
                                        data.cell.y + data.cell.height
                                    );
                                    
                                    // Línea derecha de Cód Barras
                                    doc.line(
                                        data.cell.x + data.cell.width, 
                                        data.cell.y, 
                                        data.cell.x + data.cell.width, 
                                        data.cell.y + data.cell.height
                                    );
                                    
                                    console.log(`✅ Código de barras en celda de ${data.cell.width}mm`);
                                    
                                } catch (error) {
                                    console.error(`❌ Error generando código de barras para ${producto.sku}:`, error);
                                    // Fallback: mostrar texto
                                    if (data.cell) {
                                        doc.setFontSize(5);
                                        const textoMostrar = codigoBarras.length > 20 ? codigoBarras.substring(0, 20) + '...' : codigoBarras;
                                        const textWidth = doc.getTextWidth(textoMostrar);
                                        const textX = data.cell.x + (data.cell.width - textWidth) / 2;
                                        doc.text(textoMostrar, textX, data.cell.y + 7);
                                    }
                                }
                            }
                        },
                        tableLineWidth: 0.1,
                        tableLineColor: [255, 255, 255],
                        margin: { top: currentY, bottom: 10 },
                        pageBreak: 'auto'
                    });

                });

                // Guardar PDF
                const pdfBlob = doc.output('blob');
                const pdfUrl = URL.createObjectURL(pdfBlob);
                
                // Mostrar resultado
                progreso.style.display = 'none';
                resultado.innerHTML = `
                    <div class="success" style="margin-top: 20px;">
                        <p>✅ Reporte generado correctamente!</p>
                    </div>
                `;

                // Auto-abrir en nueva pestaña para imprimir
                setTimeout(() => {
                    window.open(pdfUrl, '_blank');
                }, 1000);

            } catch (error) {
                console.error('❌ Error generando PDF:', error);
                document.getElementById('progreso-reporte').innerHTML = `<p class="error">❌ Error: ${error.message}</p>`;
            }
        }

        // INICIALIZACIÓN
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🔄 DOM cargado, iniciando aplicación...');
            inicializarApp();
        });

        async function inicializarApp() {
            console.log('🚀 Inicializando aplicación...');
            
            // Inicializar Firebase primero
            await inicializarFirebase();
            await cargarTablaReferencia();
            
            // Configurar fechas
            document.getElementById('fecha').value = fechaActual;
            document.getElementById('fecha-resumen').value = fechaActual;
            document.getElementById('fecha-reporte').value = fechaActual;
            document.getElementById('fecha-historico').value = fechaActual;
            
            // Configurar navegación
            document.getElementById('btn-cargar').addEventListener('click', () => mostrarSeccion('cargar'));
            document.getElementById('btn-resumen').addEventListener('click', () => {
                mostrarSeccion('resumen');
                actualizarSelectorResumen();
                mostrarResumenDesdeDatosCargados();
            });
            document.getElementById('btn-reporte').addEventListener('click', () => {
                mostrarSeccion('reporte');
                actualizarSelectorPasillos();
                actualizarFechaReporte();
            });
            document.getElementById('btn-historico').addEventListener('click', () => mostrarSeccion('historico'));
            
            // Configurar eventos
            document.getElementById('btn-cargar-datos').addEventListener('click', procesarDatosCSV);
            document.getElementById('btn-actualizar-resumen').addEventListener('click', mostrarResumenDesdeDatosCargados);
            document.getElementById('btn-cargar-desde-firebase').addEventListener('click', cargarYMostrarDesdeFirebase);
            document.getElementById('btn-actualizar-reporte').addEventListener('click', actualizarFechaReporte);
            document.getElementById('texto-csv').addEventListener('input', actualizarContadorLineas);
            document.getElementById('link-ver-resumen').addEventListener('click', function(e) {
                e.preventDefault();
                mostrarSeccion('resumen');
                mostrarResumenDesdeDatosCargados();
            });
            document.getElementById('btn-generar-pdf').addEventListener('click', generarReportePDF);
            document.getElementById('btn-cargar-historico').addEventListener('click', cargarHistoricoDesdeFirebase);

            actualizarContadorLineas();
            console.log('✅ Aplicación inicializada correctamente');
        }

        // SISTEMA DE PREVENCIÓN DE CIERRE MIENTRAS GUARDA FIREBASE
function configurarPrevencionCierre() {
    window.addEventListener('beforeunload', function (e) {
        if (guardadoFirebaseEnProgreso) {
            // Mostrar advertencia personalizada
            const mensaje = '⚠️ Los datos aún se están guardando en la nube. Si sales ahora, no estarán disponibles para consultas futuras. ¿Seguro que quieres salir?';
            
            // Para navegadores modernos
            e.preventDefault();
            e.returnValue = mensaje;
            
            // Para navegadores más antiguos
            return mensaje;
        }
    });
}

// También prevenir navegación interna
function configurarPrevencionNavegacion() {
    // Interceptar clics en enlaces de navegación
    document.addEventListener('click', function(e) {
        if (guardadoFirebaseEnProgreso) {
            const target = e.target;
            
            // Verificar si es un enlace de navegación interna
            if (target.tagName === 'A' && target.getAttribute('href') && 
                !target.getAttribute('href').startsWith('http') &&
                !target.getAttribute('href').startsWith('#')) {
                
                if (!confirm('⚠️ Los datos aún se están guardando en la nube. Si navegas ahora, no estarán disponibles para consultas futuras. ¿Seguro que quieres continuar?')) {
                    e.preventDefault();
                    return false;
                }
            }
        }
    });
}
    </script>
</body>
</html>